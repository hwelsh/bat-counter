<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thetis Island Bat Count</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü¶á</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; padding: 0; font-family: 'Lexend', sans-serif; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect } = React;

    // Utility functions
    const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);

    const formatDate = (dateStr) => {
      if (!dateStr) return '';
      const date = new Date(dateStr + 'T00:00:00');
      return date.toLocaleDateString('en-CA', { year: 'numeric', month: 'short', day: 'numeric' });
    };

    // Weather code data - official descriptions from BC Annual Bat Count data form
    const RAIN_CODES = [
      { code: 1, label: 'No rain', icon: '‚òÄÔ∏è' },
      { code: 2, label: 'Foggy ‚Äì reduced visibility', icon: 'üå´Ô∏è' },
      { code: 3, label: 'Misty drizzle ‚Äì no distinct drops', icon: 'üíß' },
      { code: 4, label: 'Drizzle ‚Äì fine drops visible', icon: 'üåßÔ∏è' },
      { code: 5, label: 'Light rain ‚Äì puddles not forming quickly', icon: 'üåßÔ∏è' },
      { code: 6, label: 'Hard rain ‚Äì puddles form quickly', icon: '‚õàÔ∏è' },
    ];

    const CLOUD_CODES = [
      { code: 1, label: 'Clear ‚Äì few clouds', icon: '‚òÄÔ∏è' },
      { code: 2, label: 'Scattered ‚Äì less than half sky', icon: '‚õÖ' },
      { code: 3, label: 'Mostly cloudy ‚Äì more than 50%', icon: 'üå•Ô∏è' },
      { code: 4, label: 'Very cloudy ‚Äì unbroken clouds', icon: '‚òÅÔ∏è' },
      { code: 5, label: 'Showers ‚Äì steady soaking rain', icon: 'üåßÔ∏è' },
      { code: 6, label: 'Thunderstorms', icon: '‚õàÔ∏è' },
    ];

    const WIND_CODES = [
      { code: 1, label: 'Calm ‚Äì leaves still (0 km/h)', icon: 'üçÉ' },
      { code: 2, label: 'Slight breeze ‚Äì leaves rustling (1-11 km/h)', icon: 'üåø' },
      { code: 3, label: 'Gentle breeze ‚Äì twigs in motion (13-19 km/h)', icon: 'üå¨Ô∏è' },
      { code: 4, label: 'Moderate ‚Äì small branches move (20-29 km/h)', icon: 'üí®' },
      { code: 5, label: 'Windy ‚Äì small trees sway (30+ km/h)', icon: 'üå™Ô∏è' },
      { code: 6, label: 'Not recorded', icon: '‚ùì' },
    ];

    const ROOST_TYPES = [
      'Barn', 'House - occupied', 'House - unoccupied', 'Church', 
      'Outbuilding', 'Bridge', 'Tree', 'Bat box/condo', 'Other',
    ];

    const ROOST_LOCATIONS = [
      'Attic', 'Siding', 'Fascia board', 'Soffits', 'Roof', 'Flashing', 'Other',
    ];

    const INVENTORY_METHODS = [
      '', 'historic guano', 'exit count', 'visual survey', 'acoustic survey', 'capture', 'other'
    ];

    const DETECT_TYPES = [
      '', 'Echometer', 'Anabat', 'SM2BAT', 'SM4BAT', 'other acoustic', 'visual', 'capture'
    ];

    const BAT_SPECIES = [
      'Little Brown Myotis', 'Yuma Myotis', 'Big Brown Bat', 'California Myotis',
      'Long-eared Myotis', 'Long-legged Myotis', "Townsend's Big-eared Bat",
      'Unknown / Not identified', 'Mixed colony (multiple species)',
    ];

    // BC Bats Structure Type codes mapping
    const ROOST_TYPE_TO_CODE = {
      'Barn': 1,
      'House - unoccupied': 2,
      'House - occupied': 3,
      'Church': 4,
      'Outbuilding': 5,
      'Bridge': 6,
      'Tree': 7,
      'Bat box/condo': 8,
      'Other': 9
    };

    // Convert lat/long to UTM coordinates using proj4
    const latLongToUTM = (coordString) => {
      if (!coordString || !window.proj4) return { zone: 10, easting: '', northing: '' };
      
      try {
        // Parse "48.9834, -123.6729" format
        const parts = coordString.split(',').map(s => parseFloat(s.trim()));
        if (parts.length !== 2 || isNaN(parts[0]) || isNaN(parts[1])) {
          return { zone: 10, easting: '', northing: '' };
        }
        
        const [lat, lng] = parts;
        
        // Determine UTM zone (for BC, typically zone 10 or 11)
        const zone = Math.floor((lng + 180) / 6) + 1;
        
        // Define projections
        const wgs84 = '+proj=longlat +datum=WGS84 +no_defs';
        const utm = `+proj=utm +zone=${zone} +datum=WGS84 +units=m +no_defs`;
        
        // Convert
        const result = proj4(wgs84, utm, [lng, lat]);
        
        return {
          zone: zone,
          easting: Math.round(result[0]),
          northing: Math.round(result[1])
        };
      } catch (e) {
        console.error('UTM conversion error:', e);
        return { zone: 10, easting: '', northing: '' };
      }
    };

    // Map pups field to BC Bats format
    const mapPupsToCode = (value) => {
      if (value === 'Yes') return 'Y';
      if (value === 'No') return 'N';
      return '?';
    };

    function BatCountApp() {
      // State
      const [view, setView] = useState('home');
      const [myInfo, setMyInfo] = useState({});
      const [properties, setProperties] = useState([]);
      const [sites, setSites] = useState([]);
      const [counts, setCounts] = useState([]);
      const [editingProperty, setEditingProperty] = useState(null);
      const [editingSite, setEditingSite] = useState(null);
      const [editingCount, setEditingCount] = useState(null);
      const [countForm, setCountForm] = useState({});
      const [message, setMessage] = useState(null);

      // Load data from localStorage on mount
      useEffect(() => {
        const savedMyInfo = localStorage.getItem('batcount_myinfo');
        const savedProperties = localStorage.getItem('batcount_properties');
        const savedSites = localStorage.getItem('batcount_sites');
        const savedCounts = localStorage.getItem('batcount_counts');
        
        if (savedMyInfo) setMyInfo(JSON.parse(savedMyInfo));
        if (savedProperties) setProperties(JSON.parse(savedProperties));
        if (savedSites) setSites(JSON.parse(savedSites));
        if (savedCounts) setCounts(JSON.parse(savedCounts));
      }, []);

      // Save to localStorage whenever data changes
      useEffect(() => { localStorage.setItem('batcount_myinfo', JSON.stringify(myInfo)); }, [myInfo]);
      useEffect(() => { localStorage.setItem('batcount_properties', JSON.stringify(properties)); }, [properties]);
      useEffect(() => { localStorage.setItem('batcount_sites', JSON.stringify(sites)); }, [sites]);
      useEffect(() => { localStorage.setItem('batcount_counts', JSON.stringify(counts)); }, [counts]);

      const showMessage = (text, type = 'success') => {
        setMessage({ text, type });
        setTimeout(() => setMessage(null), 3000);
      };

      // Property management
      const saveProperty = (propertyData) => {
        if (propertyData.id) {
          setProperties(properties.map(p => p.id === propertyData.id ? propertyData : p));
          showMessage('Property updated!');
        } else {
          setProperties([...properties, { ...propertyData, id: generateId() }]);
          showMessage('Property added!');
        }
        setEditingProperty(null);
        setView('properties');
      };

      const deleteProperty = (propertyId) => {
        const propertySites = sites.filter(s => s.propertyId === propertyId);
        if (propertySites.length > 0) {
          showMessage('Cannot delete - property has ' + propertySites.length + ' roost site(s)', 'error');
          return;
        }
        if (window.confirm('Delete this property?')) {
          setProperties(properties.filter(p => p.id !== propertyId));
          showMessage('Property deleted');
        }
      };

      // Site management
      const saveSite = (siteData) => {
        if (siteData.id) {
          setSites(sites.map(s => s.id === siteData.id ? siteData : s));
          showMessage('Roost site updated!');
        } else {
          setSites([...sites, { ...siteData, id: generateId() }]);
          showMessage('Roost site added!');
        }
        setEditingSite(null);
        setView('properties');
      };

      const deleteSite = (siteId) => {
        const siteHasCounts = counts.some(c => c.siteId === siteId);
        if (siteHasCounts) {
          if (!window.confirm('This site has count records. Delete anyway? (Count records will be kept but orphaned)')) {
            return;
          }
        } else {
          if (!window.confirm('Delete this roost site?')) return;
        }
        setSites(sites.filter(s => s.id !== siteId));
        showMessage('Roost site deleted');
      };

      // Count management
      const saveCount = (countData) => {
        const newCount = { ...countData, id: generateId(), createdAt: new Date().toISOString() };
        setCounts([...counts, newCount]);
        showMessage('Counting session saved!');
        setCountForm({});
        setView('home');
      };

      const updateCount = (countData) => {
        setCounts(counts.map(c => c.id === countData.id ? { ...countData, updatedAt: new Date().toISOString() } : c));
        showMessage('Counting session updated!');
        setEditingCount(null);
        setView('history');
      };

      const deleteCount = (countId) => {
        if (window.confirm('Delete this count record?')) {
          setCounts(counts.filter(c => c.id !== countId));
          showMessage('Counting session deleted');
        }
      };

      // Export functions
      const exportBackup = () => {
        const backup = { myInfo, properties, sites, counts, exportedAt: new Date().toISOString(), version: 2 };
        const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'bat-count-backup-' + new Date().toISOString().split('T')[0] + '.json';
        a.click();
        URL.revokeObjectURL(url);
        showMessage('Backup downloaded!');
      };

      const importBackup = (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const backup = JSON.parse(e.target.result);
            // Handle v1 backups (no properties/myInfo)
            if (backup.version === 1 || (!backup.properties && backup.sites)) {
              if (window.confirm('Import v1 backup with ' + backup.sites.length + ' sites and ' + backup.counts.length + ' counts? Sites will need to be assigned to properties.')) {
                setSites(backup.sites);
                setCounts(backup.counts);
                showMessage('Backup restored! Assign sites to properties in Manage Sites.');
              }
            } else if (backup.version === 2) {
              if (window.confirm('Import backup with ' + (backup.properties?.length || 0) + ' properties, ' + backup.sites.length + ' sites, and ' + backup.counts.length + ' counts?')) {
                setMyInfo(backup.myInfo || {});
                setProperties(backup.properties || []);
                setSites(backup.sites || []);
                setCounts(backup.counts || []);
                showMessage('Backup restored!');
              }
            } else {
              showMessage('Invalid backup file', 'error');
            }
          } catch (err) {
            showMessage('Could not read backup file', 'error');
          }
        };
        reader.readAsText(file);
        event.target.value = '';
      };

      // BC Bats Excel Export Function
      const exportToBCBats = async () => {
        const surveyName = myInfo.surveyName || 'Thetis Island Bat Watch';
        const currentYear = new Date().getFullYear();

        // Create workbook using ExcelJS
        const workbook = new ExcelJS.Workbook();
        workbook.creator = 'Thetis Island Bat Count App';
        workbook.created = new Date();

        // Header style: soft yellow background, vertical text, Arial 12pt, right-justified, with borders
        const headerStyle = {
          fill: {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FFFFFFCC' }
          },
          alignment: {
            textRotation: 90,
            vertical: 'bottom',
            horizontal: 'right',
            wrapText: true
          },
          font: {
            name: 'Arial',
            size: 12,
            bold: false
          },
          border: {
            top: { style: 'thin', color: { argb: 'FF999999' } },
            left: { style: 'thin', color: { argb: 'FF999999' } },
            bottom: { style: 'thin', color: { argb: 'FF999999' } },
            right: { style: 'thin', color: { argb: 'FF999999' } }
          }
        };

        // Data row style: Arial 10pt
        const dataFont = {
          name: 'Arial',
          size: 10
        };

        // Helper function to add a sheet with styled headers
        const addSheet = (name, headers, rows, colWidths = []) => {
          const sheet = workbook.addWorksheet(name);
          
          // Add header row
          const headerRow = sheet.addRow(headers);
          headerRow.height = 100; // Tall row for vertical text
          
          // Style each header cell
          headerRow.eachCell((cell, colNumber) => {
            cell.fill = headerStyle.fill;
            cell.alignment = headerStyle.alignment;
            cell.font = headerStyle.font;
            cell.border = headerStyle.border;
          });
          
          // Add data rows with Arial 10pt font
          rows.forEach(row => {
            const dataRow = sheet.addRow(row);
            dataRow.eachCell((cell) => {
              cell.font = dataFont;
            });
          });
          
          // Set column widths
          if (colWidths.length > 0) {
            colWidths.forEach((width, index) => {
              sheet.getColumn(index + 1).width = width;
            });
          } else {
            // Auto-width columns (min 10)
            headers.forEach((_, index) => {
              sheet.getColumn(index + 1).width = 15;
            });
          }
          
          return sheet;
        };

        // ===== SHEET 1: Project Information =====
        addSheet('Project Information',
          ['SPI Project ID', 'Project Name', 'Survey Name'],
          [['5242', '2012- ongoing - Bats - British Columbia - British Columbia - MFLNRO', surveyName]],
          [15, 65, 30]
        );

        // ===== SHEET 2: Sample Station Information =====
        const sampleStationHeaders = [
          'Study Area Name', 'Sample Station Label', 'UTM Zone Sample Station', 
          'Easting Sample Station', 'Northing Sample Station', 'Structure Type',
          'Structure used by people?', 'Eviction planned?', 'Renovation or\nDemolition planned?',
          'Multiple Roosts monitored?', 'Property Owner Name', 'Owner Address ',
          'Owner Phone', 'Owner Email', 'Sample Station Comments'
        ];

        const sampleStationRows = sites.map(site => {
          const property = properties.find(p => p.id === site.propertyId) || {};
          const landowner = property.sameAsPrimary ? myInfo : property;
          const utm = latLongToUTM(site.coordinates);
          const structureCode = ROOST_TYPE_TO_CODE[site.roostType] || 9;

          return [
            surveyName,
            site.name || '',
            utm.zone || 10,
            utm.easting || '',
            utm.northing || '',
            structureCode,
            site.structureUsedByPeople || 'No',
            site.evictionPlanned || 'No',
            site.renovationPlanned || 'No',
            site.multipleRoosts || 'No',
            landowner.landownerName || landowner.name || '',
            landowner.landownerAddress || landowner.address || '',
            landowner.landownerPhone || landowner.phone || '',
            landowner.landownerEmail || landowner.email || '',
            site.notes || ''
          ];
        });

        addSheet('Sample Station Information', sampleStationHeaders, sampleStationRows,
          [25, 20, 12, 12, 12, 12, 18, 15, 18, 18, 22, 25, 15, 25, 40]
        );

        // ===== SHEET 3: General Survey (73 columns) =====
        const generalSurveyHeaders = [
          'Study Area Name', 'Sample Station Label', 'Surveyor', 'Year', 'Month', 'Day', 'Date',
          'Rain Code', 'Cloud Code', 'Wind Code', 'Start Temp (C)', 'Start Time', 'First Bat Time', 'End Time',
          'Count 1', 'Animal ID', 'UTM Zone', 'Easting', 'Northing', 'Count 2', 'Pups (YlN)', 'Total Volunteers #',
          'Comments', 'Species', 'Inventory Method', 'Spatial Accuracy (m)', 'Detect Type', 'Detect Direction (deg)',
          'Detect Distance (m)', 'Temporary Animal ID', 'Life Stage', 'Sex', 'Behaviour', 'Feature Type',
          'Feature Label', 'Feature Count', 'Sign Type', 'Sign or Sample Age', 'Sign Count', 'Group Label',
          'Adult Males', 'Adult Females', 'Adults - Unclassified Sex', 'Juvenile Males', 'Juvenile Females',
          'Juveniles - Unclassified Sex', 'Males - Unclassified Life Stage', 'Females - Unclassified Life Stage',
          'Unclassified Life Stage and Sex', 'Eggs', 'Hatchlings', 'Fledglings', 'Reliable Observer',
          'Quality Observation', 'Sampling Condition Type', 'Wind Direction', 'Current Precipitation',
          'Rainfall over 24 hours (mm)', 'Cloud Type', 'Cloud Cover', 'Cloud Ceiling', 'Lunar Phase',
          'SC Comments', 'Sky (Pre-2014)', 'Primary Counter Contact Address', 'Primary Counter Contact Phone',
          'Primary Conter Contact Email', 'Property Owner Name', 'Owner Address ', 'Owner Phone', 'Owner Email',
          'Species ID Method', 'Year of Species ID'
        ];

        const generalSurveyRows = counts.map(count => {
          const site = sites.find(s => s.id === count.siteId) || {};
          const property = properties.find(p => p.id === site.propertyId) || {};
          const landowner = property.sameAsPrimary ? myInfo : property;
          const countDate = new Date(count.date + 'T00:00:00');

          // Format time with seconds
          const formatTime = (t) => t ? (t.includes(':') && t.split(':').length === 2 ? t + ':00' : t) : '';
          
          // Format temperature with C suffix
          const formatTemp = (t) => t ? t + 'C' : '';

          return [
            surveyName,                                          // 0: Study Area Name
            site.name || '',                                     // 1: Sample Station Label
            myInfo.name || '',                                   // 2: Surveyor
            countDate.getFullYear(),                            // 3: Year
            countDate.getMonth() + 1,                           // 4: Month
            countDate.getDate(),                                // 5: Day
            count.date,                                          // 6: Date
            count.rainCode || '',                               // 7: Rain Code
            count.cloudCode || '',                              // 8: Cloud Code
            count.windCode || '',                               // 9: Wind Code
            formatTemp(count.startTemp),                        // 10: Start Temp (C)
            formatTime(count.startTime),                        // 11: Start Time
            formatTime(count.firstBatTime),                     // 12: First Bat Time
            formatTime(count.endTime),                          // 13: End Time
            count.counter1Total || 0,                           // 14: Count 1
            '',                                                  // 15: Animal ID
            '',                                                  // 16: UTM Zone
            '',                                                  // 17: Easting
            '',                                                  // 18: Northing
            count.counter2Total || '',                          // 19: Count 2
            mapPupsToCode(count.pupsSeenHeard),                 // 20: Pups (YlN)
            count.volunteerCount || '',                         // 21: Total Volunteers #
            count.comments || '',                               // 22: Comments
            count.species || '',                                // 23: Species
            site.inventoryMethod || '',                         // 24: Inventory Method (from site)
            '',                                                  // 25: Spatial Accuracy (m)
            site.detectType || '',                              // 26: Detect Type (from site)
            '', '',                                              // 27-28: Detect Direction, Detect Distance
            '', '', '', '', '', '',                             // 29-34: Various blank fields
            '', '', '', '', '', '',                             // 35-40: More blank fields
            '', '', '', '', '', '', '', '', '', '',             // 41-50: Demographics (blank)
            '', '', '', '', '', '', '', '', '', '',             // 51-60: More blank fields
            '', '', '',                                         // 61-63: Lunar Phase, SC Comments, Sky
            myInfo.address || '',                               // 64: Primary Counter Contact Address
            myInfo.phone || '',                                 // 65: Primary Counter Contact Phone
            myInfo.email || '',                                 // 66: Primary Counter Contact Email
            landowner.landownerName || landowner.name || '',    // 67: Property Owner Name
            landowner.landownerAddress || landowner.address || '', // 68: Owner Address
            landowner.landownerPhone || landowner.phone || '',  // 69: Owner Phone
            landowner.landownerEmail || landowner.email || '',  // 70: Owner Email
            '',                                                  // 71: Species ID Method
            ''                                                   // 72: Year of Species ID
          ];
        });

        addSheet('General Survey', generalSurveyHeaders, generalSurveyRows);

        // ===== SHEET 4: Incidental Observations (headers only) =====
        const incidentalHeaders = [
          'Date & Time', 'Observer First Name', 'Observer Last Name', 'Info About Observer',
          'Location', 'Habitat Description', 'Species', 'UTM Zone', 'Easting', 'Northing',
          'Spatial Accuracy (m)', 'Activity', 'Actv Desc', 'Actv Count', 'Adult Males',
          'Adult Females', 'Adults - Unclassified Sex', 'Juvenile Males', 'Juvenile Females',
          'Juveniles - Unclassified Sex', 'Unclassified Life Stage and Sex', 'Eggs', 'Egg Masses',
          'Larvae', 'Pupae', 'Air Temp (C)', 'Wind Speed', 'Cloud Cover', 'Precipitation',
          'Comments', 'Add your new field here'
        ];
        addSheet('Incidental Observations', incidentalHeaders, []);

        // ===== SHEET 5: Definitions of Fields and Codes =====
        const definitionsHeaders = ['Data Field Name', 'Data Field Description', 'Code for in Data Field', 'Code Meaning', 'Code Description'];
        const definitionsRows = [
          ['Structure Type', 'Type of structure where bats roost', '1', 'Barn', ''],
          ['Structure Type', 'Type of structure where bats roost', '2', 'Unoccupied house', ''],
          ['Structure Type', 'Type of structure where bats roost', '3', 'Occumpied house', ''],
          ['Structure Type', 'Type of structure where bats roost', '4', 'Church', ''],
          ['Structure Type', 'Type of structure where bats roost', '5', 'Out building ', ''],
          ['Structure Type', 'Type of structure where bats roost', '6', 'Bridge', ''],
          ['Structure Type', 'Type of structure where bats roost', '7', 'Tree', ''],
          ['Structure Type', 'Type of structure where bats roost', '8', 'Bat box/condo', ''],
          ['Structure Type', 'Type of structure where bats roost', '9', 'Other (described)', ''],
          ['Rain Code', 'Precipitation conditions', '1', 'No rain', ''],
          ['Rain Code', 'Precipitation conditions', '2', 'Foggy - reduced visibility', ''],
          ['Rain Code', 'Precipitation conditions', '3', 'Misty drizzle - no distinct drops', ''],
          ['Rain Code', 'Precipitation conditions', '4', 'Drizzle - fine drops visible', ''],
          ['Rain Code', 'Precipitation conditions', '5', 'Light rain - puddles not forming quickly', ''],
          ['Rain Code', 'Precipitation conditions', '6', 'Hard rain - puddles form quickly', ''],
          ['Cloud Code', 'Cloud cover conditions', '1', 'Clear - few clouds', ''],
          ['Cloud Code', 'Cloud cover conditions', '2', 'Scattered - less than half sky', ''],
          ['Cloud Code', 'Cloud cover conditions', '3', 'Mostly cloudy - more than 50%', ''],
          ['Cloud Code', 'Cloud cover conditions', '4', 'Very cloudy - unbroken clouds', ''],
          ['Cloud Code', 'Cloud cover conditions', '5', 'Showers - steady soaking rain', ''],
          ['Cloud Code', 'Cloud cover conditions', '6', 'Thunderstorms', ''],
          ['Wind Code', 'Wind conditions', '1', 'Calm - leaves still (0 km/h)', ''],
          ['Wind Code', 'Wind conditions', '2', 'Slight breeze - leaves rustling (1-11 km/h)', ''],
          ['Wind Code', 'Wind conditions', '3', 'Gentle breeze - twigs in motion (13-19 km/h)', ''],
          ['Wind Code', 'Wind conditions', '4', 'Moderate - small branches move (20-29 km/h)', ''],
          ['Wind Code', 'Wind conditions', '5', 'Windy - small trees sway (30+ km/h)', ''],
          ['Wind Code', 'Wind conditions', '6', 'Not recorded', ''],
          ['Pups', 'Were pups seen or heard?', 'Y', 'Yes', 'Pups were observed'],
          ['Pups', 'Were pups seen or heard?', 'N', 'No', 'No pups observed'],
          ['Pups', 'Were pups seen or heard?', '?', 'Unknown', 'Could not determine']
        ];
        addSheet('Definitions of Fields and Codes', definitionsHeaders, definitionsRows,
          [20, 35, 20, 40, 30]
        );

        // ===== SHEET 6: New Field Definitions =====
        const newFieldsHeaders = ['Data Field Name', 'Data Field Description', 'Code for in Data Field', 'Code Meaning', 'Code Description', ''];
        const newFieldsRows = [
          ['Sky ', 'weather (clouds, precip, etc)', '1', 'Clear', 'Clear to a few clouds', ''],
          ['Sky ', 'weather (clouds, precip, etc)', '2', 'Scattered clouds', 'Cloud cover less than half sky (<50%)', ''],
          ['Sky ', 'weather (clouds, precip, etc)', '3', 'Mostly cloudy  or overcast', 'Cloud cover > 50%', ''],
          ['Sky ', 'weather (clouds, precip, etc)', '4', 'Drizzle', 'Light intermittent rain', ''],
          ['Sky ', 'weather (clouds, precip, etc)', '5', 'Showers', 'Steady soaking rain', ''],
          ['Sky ', 'weather (clouds, precip, etc)', '6', 'Thunderstorms', 'Rain with thunderstorms', ''],
          ['Sky ', 'weather (clouds, precip, etc)', '7', 'not recorded', '', ''],
          ['Wind ', 'wind description and speed', '1', 'Calm', 'Leaves still 0 km/hr', ''],
          ['Wind ', 'wind description and speed', '2', 'Slight Breeze', 'Leaves slightly rustling 1-11 km/hr', ''],
          ['Wind ', 'wind description and speed', '3', 'Gentle Breeze', 'Leave and twigs  in motion 13-19 km/hr', ''],
          ['Wind ', 'wind description and speed', '4', 'Moderate Breeze', 'Small branches begin to move', '20-29 km/hr'],
          ['Wind ', 'wind description and speed', '5', 'Windy', 'Small trees or more in canopy sway 30+ km/hr', ''],
          ['Wind ', 'wind description and speed', '6', 'not recorded', '', ''],
          ['Study Area Name', 'What bat project / region', 'TIBW', 'Thetis Island Bat Watch', 'Thetis Island, BC', '']
        ];
        addSheet('New Field Definitions', newFieldsHeaders, newFieldsRows,
          [20, 30, 20, 25, 35, 10]
        );

        // Generate and download the file
        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `BC_AnnualBatCount_${currentYear}_${surveyName.replace(/[^a-zA-Z0-9]/g, '_')}.xlsx`;
        a.click();
        URL.revokeObjectURL(url);
        showMessage('BC Bats Excel file exported!');
      };

      // Helper functions
      const getCountsForSite = (siteId) => counts.filter(c => c.siteId === siteId).sort((a, b) => new Date(b.date) - new Date(a.date));
      
      const getSitesForProperty = (propertyId) => sites.filter(s => s.propertyId === propertyId);

      const getYearSummary = (siteId) => {
        const siteCounts = getCountsForSite(siteId);
        const byYear = {};
        siteCounts.forEach(count => {
          const year = new Date(count.date).getFullYear();
          if (!byYear[year]) byYear[year] = { counts: 0, totalBats: 0, maxBats: 0 };
          byYear[year].counts++;
          const total = parseInt(count.counter1Total) || 0; // Use Counter 1 only
          byYear[year].totalBats += total;
          byYear[year].maxBats = Math.max(byYear[year].maxBats, total);
        });
        return Object.entries(byYear).sort(([a], [b]) => b - a).map(([year, data]) => ({ year, ...data }));
      };

      const getSiteDisplayName = (site) => {
        const property = properties.find(p => p.id === site.propertyId);
        return property ? `${property.name} - ${site.name}` : site.name;
      };

      // Season view helpers
      const getSeasonSlot = (dateStr) => {
        if (!dateStr) return null;
        const date = new Date(dateStr + 'T00:00:00');
        const month = date.getMonth(); // 0-indexed
        const day = date.getDate();
        
        // June 1-21 = slots 0, 1
        if (month === 5 && day >= 1 && day <= 21) return 'june';
        // July 11 - Aug 5 = slots 2, 3
        if ((month === 6 && day >= 11) || (month === 7 && day >= 1 && day <= 5)) return 'julyAug';
        // Outside official windows
        return 'other';
      };

      const getSeasonData = (propertyId, year) => {
        const propertySites = getSitesForProperty(propertyId);
        
        return propertySites.map(site => {
          const siteCounts = counts
            .filter(c => c.siteId === site.id && new Date(c.date).getFullYear() === year)
            .sort((a, b) => new Date(a.date) - new Date(b.date));
          
          const juneCounts = siteCounts.filter(c => getSeasonSlot(c.date) === 'june');
          const julyAugCounts = siteCounts.filter(c => getSeasonSlot(c.date) === 'julyAug');
          const otherCounts = siteCounts.filter(c => getSeasonSlot(c.date) === 'other');
          
          return {
            site,
            june1: juneCounts[0] || null,
            june2: juneCounts[1] || null,
            julyAug1: julyAugCounts[0] || null,
            julyAug2: julyAugCounts[1] || null,
            other: otherCounts,
            totalBats: siteCounts.reduce((sum, c) => sum + (parseInt(c.counter1Total) || 0), 0), // Counter 1 only
          };
        });
      };

      const getCountTotal = (count) => {
        if (!count) return null;
        return parseInt(count.counter1Total) || 0; // Counter 1 only
      };

      const getAvailableYears = () => {
        const years = [...new Set(counts.map(c => new Date(c.date).getFullYear()))];
        return years.sort((a, b) => b - a);
      };

      // Styles - Nature-inspired, classy color palette
      const colors = {
        forest: '#1a3c34',        // Deep forest green - primary
        sage: '#4a7c6f',          // Sage green - secondary
        moss: '#7ba38f',          // Moss green - accents
        cream: '#f9f6f0',         // Warm cream - background
        sand: '#e8e4dc',          // Sandy beige - cards
        bark: '#5c4a3d',          // Warm brown - text accents
        gold: '#c9a227',          // Muted gold - highlights
        white: '#ffffff',
        text: '#2d2a26',          // Warm dark brown - main text
        textLight: '#6b6560',     // Muted brown - secondary text
      };

      const styles = {
        container: { fontFamily: '"Lexend", sans-serif', maxWidth: '900px', margin: '0 auto', padding: '24px', backgroundColor: colors.cream, minHeight: '100vh' },
        header: { marginBottom: '32px', paddingBottom: '24px', borderBottom: `2px solid ${colors.sand}` },
        headerTop: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '16px' },
        headerBrand: { display: 'flex', alignItems: 'center', gap: '16px' },
        title: { fontSize: '28px', fontWeight: 'bold', color: colors.forest, margin: 0 },
        subtitle: { fontSize: '14px', color: colors.textLight, margin: '4px 0 0 0', fontStyle: 'italic' },
        thincLogo: { height: '85px', width: 'auto' },
        batIcon: { fontSize: '36px' },
        navButton: { padding: '14px 24px', fontSize: '18px', fontWeight: '600', border: 'none', borderRadius: '8px', cursor: 'pointer', transition: 'all 0.2s' },
        navButtonPrimary: { backgroundColor: colors.forest, color: 'white' },
        navButtonSecondary: { backgroundColor: colors.sand, color: colors.forest },
        card: { backgroundColor: colors.white, borderRadius: '12px', padding: '28px', marginBottom: '24px', boxShadow: '0 2px 12px rgba(0,0,0,0.06)', borderLeft: `4px solid ${colors.sage}` },
        cardTitle: { fontSize: '22px', fontWeight: 'bold', color: colors.forest, marginBottom: '20px', marginTop: 0 },
        formGroup: { marginBottom: '24px' },
        label: { display: 'block', fontSize: '18px', fontWeight: '600', color: colors.text, marginBottom: '10px' },
        input: { width: '100%', padding: '16px', fontSize: '20px', border: `2px solid ${colors.sand}`, borderRadius: '8px', boxSizing: 'border-box', fontFamily: '"Lexend", sans-serif', backgroundColor: colors.white },
        select: { width: '100%', padding: '16px', fontSize: '20px', border: `2px solid ${colors.sand}`, borderRadius: '8px', backgroundColor: colors.white, fontFamily: '"Lexend", sans-serif' },
        textarea: { width: '100%', padding: '16px', fontSize: '20px', border: `2px solid ${colors.sand}`, borderRadius: '8px', minHeight: '120px', boxSizing: 'border-box', fontFamily: '"Lexend", sans-serif', backgroundColor: colors.white },
        button: { padding: '18px 36px', fontSize: '20px', fontWeight: 'bold', border: 'none', borderRadius: '8px', cursor: 'pointer', transition: 'all 0.2s', fontFamily: '"Lexend", sans-serif' },
        buttonPrimary: { backgroundColor: colors.forest, color: 'white' },
        buttonSecondary: { backgroundColor: colors.sand, color: colors.text },
        buttonDanger: { backgroundColor: '#c44536', color: 'white' },
        buttonRow: { display: 'flex', gap: '16px', marginTop: '24px', flexWrap: 'wrap' },
        helpText: { fontSize: '16px', color: colors.textLight, marginTop: '6px', fontStyle: 'italic' },
        infoBox: { backgroundColor: '#e8f4f0', border: `1px solid ${colors.moss}`, borderRadius: '8px', padding: '16px 20px', marginBottom: '24px', fontSize: '17px', lineHeight: '1.5', color: colors.forest },
        tipBox: { backgroundColor: '#f0f5e8', border: `1px solid ${colors.sage}`, borderRadius: '8px', padding: '16px 20px', marginBottom: '24px', fontSize: '17px', lineHeight: '1.5', color: colors.forest },
        warningBox: { backgroundColor: '#fdf6e3', border: `1px solid ${colors.gold}`, borderRadius: '8px', padding: '16px 20px', marginBottom: '24px', fontSize: '17px', lineHeight: '1.5', color: colors.bark },
        summaryGrid: { display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '16px', marginBottom: '24px' },
        summaryCard: { backgroundColor: colors.white, padding: '20px', borderRadius: '8px', textAlign: 'center', border: `1px solid ${colors.sand}` },
        summaryNumber: { fontSize: '36px', fontWeight: 'bold', color: colors.forest },
        summaryLabel: { fontSize: '16px', color: colors.textLight, marginTop: '4px' },
        propertyCard: { backgroundColor: colors.white, border: `1px solid ${colors.sand}`, borderRadius: '8px', padding: '20px', marginBottom: '16px' },
        siteCard: { backgroundColor: colors.cream, border: `1px solid ${colors.sand}`, borderRadius: '6px', padding: '16px', marginBottom: '12px', marginLeft: '20px' },
        table: { width: '100%', borderCollapse: 'collapse', fontSize: '18px' },
        th: { textAlign: 'left', padding: '16px 12px', backgroundColor: colors.forest, color: 'white', fontWeight: '600' },
        td: { padding: '16px 12px', borderBottom: `1px solid ${colors.sand}` },
        message: { position: 'fixed', top: '20px', right: '20px', padding: '16px 24px', borderRadius: '8px', fontSize: '18px', fontWeight: '600', zIndex: 1000, boxShadow: '0 4px 12px rgba(0,0,0,0.15)' },
        messageSuccess: { backgroundColor: '#d4edda', color: '#155724' },
        messageError: { backgroundColor: '#f8d7da', color: '#721c24' },
        codeButtonGrid: { display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '12px' },
        codeButton: { padding: '16px 12px', fontSize: '16px', border: `3px solid ${colors.sand}`, borderRadius: '8px', cursor: 'pointer', backgroundColor: colors.white, transition: 'all 0.2s', textAlign: 'center', fontFamily: '"Lexend", sans-serif' },
        codeButtonSelected: { borderColor: colors.forest, backgroundColor: '#e8f4f0' },
        codeButtonIcon: { fontSize: '28px', display: 'block', marginBottom: '6px' },
        radioGroup: { display: 'flex', gap: '24px', flexWrap: 'wrap' },
        radioLabel: { display: 'flex', alignItems: 'center', gap: '10px', fontSize: '20px', cursor: 'pointer' },
        radioInput: { width: '24px', height: '24px', cursor: 'pointer' },
        checkboxLabel: { display: 'flex', alignItems: 'center', gap: '12px', fontSize: '18px', cursor: 'pointer', padding: '12px', backgroundColor: colors.cream, borderRadius: '8px' },
        checkbox: { width: '24px', height: '24px', cursor: 'pointer' },
        emptyState: { textAlign: 'center', padding: '48px', color: colors.textLight, fontSize: '20px' },
        yearRow: { display: 'flex', justifyContent: 'space-between', padding: '12px 16px', backgroundColor: colors.cream, borderRadius: '6px', marginBottom: '8px', fontSize: '18px' },
        // Season Progress Indicator
        progressContainer: { backgroundColor: colors.white, borderRadius: '12px', padding: '24px', marginBottom: '24px', border: `1px solid ${colors.sand}` },
        progressTitle: { fontSize: '18px', fontWeight: '600', color: colors.forest, marginBottom: '16px', display: 'flex', alignItems: 'center', gap: '8px' },
        progressTrack: { display: 'flex', gap: '8px', marginBottom: '12px' },
        progressSlot: { flex: 1, textAlign: 'center' },
        progressDot: { width: '40px', height: '40px', borderRadius: '50%', margin: '0 auto 8px', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '18px', fontWeight: 'bold' },
        progressDotComplete: { backgroundColor: colors.forest, color: 'white' },
        progressDotCurrent: { backgroundColor: colors.gold, color: 'white', boxShadow: `0 0 0 4px ${colors.cream}, 0 0 0 6px ${colors.gold}` },
        progressDotUpcoming: { backgroundColor: colors.sand, color: colors.textLight },
        progressLabel: { fontSize: '12px', color: colors.textLight },
        progressDate: { fontSize: '11px', color: colors.textLight, marginTop: '2px' },
      };

      // Code Button Group Component
      const CodeButtonGroup = ({ codes, value, onChange }) => (
        <div style={styles.codeButtonGrid}>
          {codes.map(code => (
            <button
              key={code.code}
              type="button"
              onClick={() => onChange(code.code)}
              style={{ ...styles.codeButton, ...(value === code.code ? styles.codeButtonSelected : {}) }}
            >
              <span style={styles.codeButtonIcon}>{code.icon}</span>
              <span>{code.code}. {code.label}</span>
            </button>
          ))}
        </div>
      );

      // ============ HOME VIEW ============
      const HomeView = () => {
        const currentYear = new Date().getFullYear();
        const thisYearCounts = counts.filter(c => new Date(c.date).getFullYear() === currentYear);
        const totalBatsThisYear = thisYearCounts.reduce((sum, c) => sum + (parseInt(c.counter1Total) || 0), 0); // Counter 1 only
        const needsSetup = !myInfo.name;

        // All-time stats
        const totalCountSessions = counts.length;
        const totalBatsAllTime = counts.reduce((sum, c) => sum + (parseInt(c.counter1Total) || 0), 0);
        const uniqueYears = [...new Set(counts.map(c => new Date(c.date).getFullYear()))];
        const yearsActiveCount = uniqueYears.length;
        const yearsActiveRange = yearsActiveCount > 0 
          ? (yearsActiveCount === 1 
            ? `${Math.min(...uniqueYears)}` 
            : `${Math.min(...uniqueYears)}-${Math.max(...uniqueYears)}`)
          : '‚Äî';
        
        // Volunteer hours calculation (duration √ó volunteer count per session)
        const totalVolunteerHours = counts.reduce((sum, c) => {
          if (!c.startTime || !c.endTime) return sum;
          const [startH, startM] = c.startTime.split(':').map(Number);
          const [endH, endM] = c.endTime.split(':').map(Number);
          const durationHours = (endH + endM/60) - (startH + startM/60);
          const volunteers = parseInt(c.volunteerCount) || 1;
          return sum + (durationHours > 0 ? durationHours * volunteers : 0);
        }, 0);

        // Season progress calculation
        const today = new Date();
        const countPeriods = [
          { num: 1, label: 'Count #1', dateRange: 'Jun 1-21', slot: 'june' },
          { num: 2, label: 'Count #2', dateRange: 'Jun 1-21', slot: 'june' },
          { num: 3, label: 'Count #3', dateRange: 'Jul 11 - Aug 5', slot: 'julyAug' },
          { num: 4, label: 'Count #4', dateRange: 'Jul 11 - Aug 5', slot: 'julyAug' },
        ];
        
        // For each property, count how many unique count sessions they have per slot
        const getPropertySessionCounts = (slot) => {
          const slotCounts = thisYearCounts.filter(c => getSeasonSlot(c.date) === slot);
          const propertySessionCounts = {};
          
          properties.forEach(p => {
            // Get unique dates for this property in this slot
            const propertySites = sites.filter(s => s.propertyId === p.id);
            const siteIds = propertySites.map(s => s.id);
            const propertySlotCounts = slotCounts.filter(c => siteIds.includes(c.siteId));
            const uniqueDates = [...new Set(propertySlotCounts.map(c => c.date))];
            propertySessionCounts[p.id] = uniqueDates.length;
          });
          
          return propertySessionCounts;
        };
        
        const juneByProperty = getPropertySessionCounts('june');
        const julyAugByProperty = getPropertySessionCounts('julyAug');
        
        // A count period is complete only if ALL properties have that many sessions
        const totalProperties = properties.length;
        
        const getCompletedCountsForSlot = (byProperty) => {
          if (totalProperties === 0) return 0;
          // Find the minimum number of sessions any property has
          const sessionCounts = Object.values(byProperty);
          return sessionCounts.length > 0 ? Math.min(...sessionCounts) : 0;
        };
        
        const juneCompleteCounts = getCompletedCountsForSlot(juneByProperty);
        const julyAugCompleteCounts = getCompletedCountsForSlot(julyAugByProperty);
        
        const getSlotStatus = (periodNum) => {
          if (periodNum <= 2) {
            return juneCompleteCounts >= periodNum ? 'complete' : 'upcoming';
          } else {
            return julyAugCompleteCounts >= (periodNum - 2) ? 'complete' : 'upcoming';
          }
        };
        
        // Determine current period based on date
        const getCurrentPeriod = () => {
          const month = today.getMonth();
          const day = today.getDate();
          if (month < 5) return 0; // Before June
          if (month === 5 && day <= 21) return juneCompleteCounts < 2 ? (juneCompleteCounts + 1) : 2;
          if (month === 5 && day > 21 && month < 6) return 2; // Late June
          if ((month === 6 && day >= 11) || (month === 7 && day <= 5)) return julyAugCompleteCounts < 2 ? (julyAugCompleteCounts + 3) : 4;
          return 5; // After season
        };
        
        const currentPeriod = getCurrentPeriod();
        const totalComplete = juneCompleteCounts + julyAugCompleteCounts;

        return (
          <div>
            {needsSetup && (
              <div style={styles.warningBox}>
                <strong>üëã Welcome!</strong> To get started:
                <ol style={{ margin: '12px 0 0 0', paddingLeft: '20px' }}>
                  <li style={{ marginBottom: '8px' }}>
                    Set up your information in{' '}
                    <button onClick={() => setView('settings')} style={{ background: 'none', border: 'none', color: colors.bark, textDecoration: 'underline', cursor: 'pointer', fontSize: 'inherit', fontFamily: 'inherit', padding: 0 }}>
                      My Info
                    </button>
                  </li>
                  <li>
                    Add your properties and roost sites in{' '}
                    <button onClick={() => setView('properties')} style={{ background: 'none', border: 'none', color: colors.bark, textDecoration: 'underline', cursor: 'pointer', fontSize: 'inherit', fontFamily: 'inherit', padding: 0 }}>
                      Properties & Roost Sites
                    </button>
                  </li>
                </ol>
              </div>
            )}

            {/* Main Action Buttons */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '12px', marginBottom: '24px' }}>
              <button
                onClick={() => { setCountForm({ date: new Date().toISOString().split('T')[0] }); setView('newCount'); }}
                style={{ ...styles.button, ...styles.buttonPrimary, padding: '20px 16px', fontSize: '16px', display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '8px' }}
                disabled={sites.length === 0}
              >
                <span style={{ fontSize: '28px' }}>ü¶á</span>
                <span>New Counting Session</span>
              </button>
              <button
                onClick={() => setView('history')}
                style={{ ...styles.button, ...styles.buttonSecondary, padding: '20px 16px', fontSize: '16px', display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '8px' }}
              >
                <span style={{ fontSize: '28px' }}>üìì</span>
                <span>Counting Session Log</span>
              </button>
              <button
                onClick={() => setView('season')}
                style={{ ...styles.button, ...styles.buttonSecondary, padding: '20px 16px', fontSize: '16px', display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '8px' }}
              >
                <span style={{ fontSize: '28px' }}>‚òÄÔ∏è</span>
                <span>Season Overview</span>
              </button>
              <button
                onClick={() => setView('appSettings')}
                style={{ ...styles.button, ...styles.buttonSecondary, padding: '20px 16px', fontSize: '16px', display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '8px' }}
              >
                <span style={{ fontSize: '28px' }}>‚öôÔ∏è</span>
                <span>Settings</span>
              </button>
            </div>

            <h2 style={{ fontSize: '20px', fontWeight: '600', color: colors.forest, marginBottom: '16px', marginTop: '8px' }}>üìà Impact</h2>
            <div style={styles.summaryGrid}>
              <div style={styles.summaryCard}>
                <div style={styles.summaryNumber}>{yearsActiveCount}</div>
                <div style={styles.summaryLabel}>BC Annual Bat Counts</div>
              </div>
              <div style={styles.summaryCard}>
                <div style={styles.summaryNumber}>{totalBatsAllTime.toLocaleString()}</div>
                <div style={styles.summaryLabel}>Bats Counted</div>
              </div>
              <div style={styles.summaryCard}>
                <div style={styles.summaryNumber}>{totalVolunteerHours > 0 ? Math.round(totalVolunteerHours) : '‚Äî'}</div>
                <div style={styles.summaryLabel}>Volunteer Hours</div>
              </div>
            </div>
            <div style={{ display: 'flex', justifyContent: 'center', marginTop: '16px', marginBottom: '16px' }}>
              <button onClick={() => setView('impactReport')} style={{ ...styles.button, ...styles.buttonSecondary }}>
                üìä Impact Report
              </button>
            </div>

            <div style={styles.card}>
              <h2 style={styles.cardTitle}>üìÖ BC Annual Bat Count Schedule</h2>
              <div style={styles.infoBox}>
                <strong>Ideally, conduct four counts per summer:</strong>
                <ul style={{ margin: '10px 0 0 0', paddingLeft: '24px' }}>
                  <li><strong>June 1‚Äì21:</strong> Two counts (before pups can fly)</li>
                  <li><strong>July 11‚ÄìAugust 5:</strong> Two counts (when pups are flying with mothers)</li>
                </ul>
                <p style={{ margin: '12px 0 0 0', fontSize: '15px' }}>
                  Doing all four counts allows us to best compare data from year to year and between sites.
                </p>
                <p style={{ margin: '12px 0 0 0', fontSize: '15px', fontStyle: 'italic' }}>
                  üìã Please return forms to your local coordinator by <strong>September 15</strong>.
                </p>
              </div>

              {/* Season Calendar */}
              {(() => {
                // Get all count dates for current year with property info
                const countsByDate = {};
                thisYearCounts.forEach(c => {
                  const site = sites.find(s => s.id === c.siteId);
                  const property = site ? properties.find(p => p.id === site.propertyId) : null;
                  const propertyName = property ? property.name : 'Unknown';
                  
                  if (!countsByDate[c.date]) {
                    countsByDate[c.date] = [];
                  }
                  countsByDate[c.date].push(propertyName);
                });
                
                // Helper to check if date is in count window
                const isInCountWindow = (month, day) => {
                  if (month === 5 && day >= 1 && day <= 21) return 'june';
                  if (month === 6 && day >= 11) return 'julyAug';
                  if (month === 7 && day >= 1 && day <= 5) return 'julyAug';
                  return null;
                };
                
                // Generate calendar for a month
                const renderMonth = (monthIndex, monthName) => {
                  const firstDay = new Date(currentYear, monthIndex, 1).getDay();
                  const daysInMonth = new Date(currentYear, monthIndex + 1, 0).getDate();
                  const weeks = [];
                  let currentWeek = new Array(firstDay).fill(null);
                  
                  for (let day = 1; day <= daysInMonth; day++) {
                    currentWeek.push(day);
                    if (currentWeek.length === 7) {
                      weeks.push(currentWeek);
                      currentWeek = [];
                    }
                  }
                  if (currentWeek.length > 0) {
                    while (currentWeek.length < 7) currentWeek.push(null);
                    weeks.push(currentWeek);
                  }
                  
                  return (
                    <div style={{ flex: '1', minWidth: '200px' }}>
                      <div style={{ textAlign: 'center', fontWeight: '600', color: colors.forest, marginBottom: '8px', fontSize: '16px' }}>
                        {monthName}
                      </div>
                      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: '2px', fontSize: '12px' }}>
                        {['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'].map(d => (
                          <div key={d} style={{ textAlign: 'center', color: colors.textLight, fontWeight: '500', padding: '4px 0' }}>{d}</div>
                        ))}
                        {weeks.flat().map((day, idx) => {
                          if (day === null) {
                            return <div key={idx} style={{ padding: '6px 0' }}></div>;
                          }
                          
                          const dateStr = `${currentYear}-${String(monthIndex + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                          const dateProperties = countsByDate[dateStr] || [];
                          const hasCount = dateProperties.length > 0;
                          const countWindow = isInCountWindow(monthIndex, day);
                          
                          const uniqueProperties = [...new Set(dateProperties)];
                          const tooltipText = hasCount ? uniqueProperties.join(', ') : '';
                          
                          let bgColor = 'transparent';
                          let textColor = colors.text;
                          
                          if (countWindow === 'june') {
                            bgColor = 'rgba(143, 186, 190, 0.3)';
                          } else if (countWindow === 'julyAug') {
                            bgColor = 'rgba(74, 124, 89, 0.2)';
                          }
                          
                          if (hasCount) {
                            bgColor = colors.forest;
                            textColor = '#ffffff';
                          }
                          
                          return (
                            <div 
                              key={idx} 
                              title={tooltipText}
                              style={{ 
                                textAlign: 'center', 
                                padding: '6px 0',
                                backgroundColor: bgColor,
                                color: textColor,
                                borderRadius: hasCount ? '50%' : '2px',
                                fontWeight: hasCount ? '600' : '400',
                                cursor: hasCount ? 'pointer' : 'default',
                              }}
                            >
                              {day}
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  );
                };
                
                return (
                  <div style={{ marginTop: '24px' }}>
                    <div style={{ display: 'flex', gap: '24px', flexWrap: 'wrap', justifyContent: 'center' }}>
                      {renderMonth(5, 'June')}
                      {renderMonth(6, 'July')}
                      {renderMonth(7, 'August')}
                    </div>
                    <div style={{ display: 'flex', justifyContent: 'center', gap: '20px', marginTop: '16px', fontSize: '13px', color: colors.textLight, flexWrap: 'wrap' }}>
                      <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                        <div style={{ width: '16px', height: '16px', backgroundColor: 'rgba(143, 186, 190, 0.3)', borderRadius: '2px' }}></div>
                        <span>Jun 1-21</span>
                      </div>
                      <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                        <div style={{ width: '16px', height: '16px', backgroundColor: 'rgba(74, 124, 89, 0.2)', borderRadius: '2px' }}></div>
                        <span>Jul 11 - Aug 5</span>
                      </div>
                      <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                        <div style={{ width: '16px', height: '16px', backgroundColor: colors.forest, borderRadius: '50%' }}></div>
                        <span>Count completed</span>
                      </div>
                    </div>
                  </div>
                );
              })()}
            </div>

            {thisYearCounts.length > 0 && (
              <div style={styles.card}>
                <h2 style={styles.cardTitle}>Recent Counting Sessions</h2>
                <table style={styles.table}>
                  <thead>
                    <tr>
                      <th style={styles.th}>Date</th>
                      <th style={styles.th}>Property</th>
                      <th style={styles.th}>Sites Counted</th>
                      <th style={styles.th}>Total Bats</th>
                    </tr>
                  </thead>
                  <tbody>
                    {(() => {
                      // Group counts by property and date
                      const grouped = {};
                      thisYearCounts.forEach(count => {
                        const site = sites.find(s => s.id === count.siteId);
                        const property = site ? properties.find(p => p.id === site.propertyId) : null;
                        const key = `${count.date}-${property?.id || 'unknown'}`;
                        if (!grouped[key]) {
                          grouped[key] = {
                            date: count.date,
                            property: property,
                            sites: [],
                            totalBats: 0
                          };
                        }
                        grouped[key].sites.push(site);
                        grouped[key].totalBats += parseInt(count.counter1Total) || 0; // Counter 1 only
                      });
                      
                      return Object.values(grouped)
                        .sort((a, b) => new Date(b.date) - new Date(a.date))
                        .slice(0, 5)
                        .map((group, idx) => (
                          <tr key={idx}>
                            <td style={styles.td}>{formatDate(group.date)}</td>
                            <td style={styles.td}>{group.property?.name || 'Unknown'}</td>
                            <td style={styles.td}>{group.sites.length}</td>
                            <td style={styles.td}>{group.totalBats}</td>
                          </tr>
                        ));
                    })()}
                  </tbody>
                </table>
                <p style={{ ...styles.helpText, marginTop: '12px', textAlign: 'center' }}>
                  Totals use Counter 1. Counter 2 is recorded for BC Bats data validation.
                </p>
              </div>
            )}
          </div>
        );
      };

      // ============ MY INFO VIEW (formerly Settings) ============
      const SettingsView = () => {
        const [form, setForm] = useState(myInfo);

        const handleSave = (e) => {
          e.preventDefault();
          setMyInfo(form);
          showMessage('My Info saved!');
          setView('appSettings');
        };

        return (
          <form onSubmit={handleSave}>
            <div style={styles.card}>
              <h2 style={styles.cardTitle}>üë§ My Info (Primary Bat Counter)</h2>
              <div style={styles.infoBox}>
                This is your contact information as the primary bat counter. It will be included in all data exports.
              </div>

              <div style={styles.formGroup}>
                <label style={styles.label}>Your Name *</label>
                <input type="text" value={form.name || ''} onChange={(e) => setForm({ ...form, name: e.target.value })} style={styles.input} placeholder="e.g. Rob Welsh" />
              </div>

              <div style={styles.formGroup}>
                <label style={styles.label}>Address</label>
                <input type="text" value={form.address || ''} onChange={(e) => setForm({ ...form, address: e.target.value })} style={styles.input} placeholder="Street address, City, Province, Postal Code" />
              </div>

              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px' }}>
                <div style={styles.formGroup}>
                  <label style={styles.label}>Phone</label>
                  <input type="tel" value={form.phone || ''} onChange={(e) => setForm({ ...form, phone: e.target.value })} style={styles.input} placeholder="e.g. 250-555-1234" />
                </div>
                <div style={styles.formGroup}>
                  <label style={styles.label}>Email</label>
                  <input type="email" value={form.email || ''} onChange={(e) => setForm({ ...form, email: e.target.value })} style={styles.input} placeholder="e.g. rob@example.com" />
                </div>
              </div>
            </div>

            <div style={styles.card}>
              <h2 style={styles.cardTitle}>ü¶á BC Community Bat Program</h2>
              
              <div style={styles.formGroup}>
                <label style={styles.label}>Survey Name</label>
                <input type="text" value={form.surveyName || ''} onChange={(e) => setForm({ ...form, surveyName: e.target.value })} style={styles.input} placeholder="Thetis Island Bat Watch" />
                <p style={styles.helpText}>
                  This is your official survey name registered with BC Bats. It appears as the "Study Area Name" in the BC Bats database.
                </p>
                <div style={{ ...styles.warningBox, marginTop: '12px' }}>
                  ‚ö†Ô∏è Only change this if instructed by your regional coordinator.
                </div>
              </div>
            </div>

            <div style={styles.buttonRow}>
              <button type="submit" style={{ ...styles.button, ...styles.buttonPrimary }}>üíæ Save Settings</button>
              <button type="button" onClick={() => setView('appSettings')} style={{ ...styles.button, ...styles.buttonSecondary }}>Cancel</button>
            </div>
          </form>
        );
      };

      // ============ APP SETTINGS VIEW (Manage section) ============
      const AppSettingsView = () => {
        return (
          <div>
            <div style={styles.card}>
              <h2 style={styles.cardTitle}>‚öôÔ∏è Settings</h2>
              
              <div style={{ marginBottom: '24px' }}>
                <h3 style={{ fontSize: '18px', color: colors.forest, marginBottom: '12px' }}>Manage</h3>
                <div style={{ display: 'flex', gap: '16px', flexWrap: 'wrap' }}>
                  <button onClick={() => setView('properties')} style={{ ...styles.button, ...styles.buttonSecondary }}>
                    üè† Properties & Roost Sites
                  </button>
                  <button onClick={() => setView('settings')} style={{ ...styles.button, ...styles.buttonSecondary }}>
                    üë§ My Info
                  </button>
                </div>
              </div>

              <div style={{ marginBottom: '24px' }}>
                <h3 style={{ fontSize: '18px', color: colors.forest, marginBottom: '12px' }}>Export Data</h3>
                <div style={{ display: 'flex', gap: '16px', flexWrap: 'wrap' }}>
                  <button onClick={exportToBCBats} style={{ ...styles.button, ...styles.buttonPrimary }} disabled={counts.length === 0}>
                    ü¶á Export for BC Bats (Excel)
                  </button>
                  <button onClick={() => setView('mileage')} style={{ ...styles.button, ...styles.buttonSecondary }}>
                    üöó Mileage Report
                  </button>
                </div>
                <p style={{ ...styles.helpText, marginTop: '12px' }}>
                  Use "Export for BC Bats" to create the official Excel file format for submission to the BC Community Bat Program.
                </p>
              </div>

              <div>
                <h3 style={{ fontSize: '18px', color: colors.forest, marginBottom: '12px' }}>Back Up</h3>
                <div style={{ display: 'flex', gap: '16px', flexWrap: 'wrap' }}>
                  <button onClick={exportBackup} style={{ ...styles.button, ...styles.buttonSecondary }}>
                    üíæ Save Backup
                  </button>
                  <label style={{ ...styles.button, ...styles.buttonSecondary, cursor: 'pointer' }}>
                    üì§ Restore Backup
                    <input type="file" accept=".json" onChange={importBackup} style={{ display: 'none' }} />
                  </label>
                </div>
                <p style={{ ...styles.helpText, marginTop: '12px' }}>
                  Data is stored locally in your browser. Remember to download a backup periodically!
                </p>
              </div>
            </div>
          </div>
        );
      };

      // ============ PROPERTIES VIEW (with inline roost site management) ============
      const PropertiesView = () => {
        // Track which property is expanded to show add site form
        const [addingSiteToPropertyId, setAddingSiteToPropertyId] = useState(null);
        const [newSiteForm, setNewSiteForm] = useState({});

        const handleAddSite = (propertyId) => {
          if (!newSiteForm.name) { 
            showMessage('Please enter a site name', 'error'); 
            return; 
          }
          saveSite({ ...newSiteForm, propertyId });
          setNewSiteForm({});
          setAddingSiteToPropertyId(null);
        };

        return (
          <div>
            <div style={styles.card}>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                <h2 style={{ ...styles.cardTitle, marginBottom: 0 }}>üè† Properties & Roost Sites</h2>
                <button onClick={() => { setEditingProperty({}); setView('editProperty'); }} style={{ ...styles.button, ...styles.buttonPrimary }}>
                  + Add Property
                </button>
              </div>

              <div style={styles.infoBox}>
                A <strong>Property</strong> represents a landowner and their land. Each property can have multiple roost sites 
                (e.g., Gary Wickett's property might have a house roof roost AND two bat boxes).
              </div>

              {properties.length === 0 ? (
                <div style={styles.emptyState}>
                  <p>No properties added yet.</p>
                  <p>Add a property first, then you can add roost sites to it.</p>
                </div>
              ) : (
                properties.map(property => {
                  const propertySites = getSitesForProperty(property.id);
                  const isAddingToThis = addingSiteToPropertyId === property.id;
                  
                  return (
                    <div key={property.id} style={styles.propertyCard}>
                      {/* Property Header */}
                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                        <div>
                          <h3 style={{ fontSize: '22px', fontWeight: 'bold', color: colors.forest, margin: '0 0 8px 0' }}>{property.name}</h3>
                          <p style={{ fontSize: '18px', color: colors.textLight, margin: '4px 0' }}>
                            {property.sameAsPrimary ? 'üë§ Same as Primary Counter' : (property.landownerName ? `üë§ ${property.landownerName}` : 'No landowner info')}
                          </p>
                          {/* Contact info */}
                          {!property.sameAsPrimary && (property.landownerPhone || property.landownerEmail) && (
                            <div style={{ fontSize: '16px', color: colors.textLight, marginTop: '4px', display: 'flex', gap: '16px', flexWrap: 'wrap' }}>
                              {property.landownerPhone && (
                                <a href={`tel:${property.landownerPhone}`} style={{ color: colors.sage, textDecoration: 'none' }}>
                                  üìû {property.landownerPhone}
                                </a>
                              )}
                              {property.landownerEmail && (
                                <a href={`mailto:${property.landownerEmail}`} style={{ color: colors.sage, textDecoration: 'none' }}>
                                  ‚úâÔ∏è {property.landownerEmail}
                                </a>
                              )}
                            </div>
                          )}
                          {/* Property notes */}
                          {property.notes && (
                            <p style={{ fontSize: '15px', color: colors.textLight, marginTop: '8px', fontStyle: 'italic', margin: '8px 0 0 0' }}>
                              üìù {property.notes}
                            </p>
                          )}
                        </div>
                        <div style={{ display: 'flex', gap: '10px' }}>
                          <button onClick={() => { setEditingProperty(property); setView('editProperty'); }} style={{ ...styles.button, ...styles.buttonSecondary, padding: '10px 16px', fontSize: '16px' }}>
                            Edit Property
                          </button>
                        </div>
                      </div>

                      {/* Roost Sites Section */}
                      <div style={{ marginTop: '20px', paddingTop: '16px', borderTop: '1px solid #e0e0e0' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                          <h4 style={{ fontSize: '18px', color: '#555', margin: 0 }}>
                            üìç Roost Sites ({propertySites.length})
                          </h4>
                          {!isAddingToThis && (
                            <button 
                              onClick={() => { setAddingSiteToPropertyId(property.id); setNewSiteForm({}); }} 
                              style={{ ...styles.button, ...styles.buttonPrimary, padding: '8px 16px', fontSize: '14px' }}
                            >
                              + Add Roost Site
                            </button>
                          )}
                        </div>

                        {/* Existing Sites */}
                        {propertySites.length > 0 ? (
                          <div>
                            {propertySites.map(site => {
                              const siteCountCount = getCountsForSite(site.id).length;
                              return (
                                <div key={site.id} style={{ ...styles.siteCard, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                  <div>
                                    <strong style={{ fontSize: '17px' }}>{site.name}</strong>
                                    <span style={{ color: '#666', marginLeft: '8px' }}>
                                      ‚Äì {site.roostType || 'Unknown type'}
                                      {site.roostLocation && ` (${site.roostLocation})`}
                                    </span>
                                    <span style={{ color: '#888', marginLeft: '12px', fontSize: '14px' }}>
                                      ‚Ä¢ {siteCountCount} count{siteCountCount !== 1 ? 's' : ''}
                                    </span>
                                  </div>
                                  <div style={{ display: 'flex', gap: '8px' }}>
                                    <button onClick={() => { setEditingSite(site); setView('editSite'); }} style={{ ...styles.button, ...styles.buttonSecondary, padding: '6px 12px', fontSize: '14px' }}>
                                      Edit
                                    </button>
                                  </div>
                                </div>
                              );
                            })}
                          </div>
                        ) : !isAddingToThis && (
                          <p style={{ color: '#888', fontStyle: 'italic', margin: '8px 0 0 20px' }}>
                            No roost sites yet. Click "+ Add Roost Site" to add one.
                          </p>
                        )}

                        {/* Inline Add Site Form */}
                        {isAddingToThis && (
                          <div style={{ backgroundColor: '#f0f7f0', border: '2px solid #a5d6a7', borderRadius: '8px', padding: '20px', marginTop: '12px' }}>
                            <h5 style={{ margin: '0 0 16px 0', fontSize: '17px', color: '#2c5530' }}>Add New Roost Site to {property.name}</h5>
                            
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', marginBottom: '16px' }}>
                              <div>
                                <label style={{ ...styles.label, fontSize: '15px' }}>Site Name *</label>
                                <input 
                                  type="text" 
                                  value={newSiteForm.name || ''} 
                                  onChange={(e) => setNewSiteForm({ ...newSiteForm, name: e.target.value })} 
                                  style={{ ...styles.input, padding: '12px', fontSize: '16px' }} 
                                  placeholder="e.g. House Roof, Bat Box #1" 
                                />
                              </div>
                              <div>
                                <label style={{ ...styles.label, fontSize: '15px' }}>Roost Type</label>
                                <select 
                                  value={newSiteForm.roostType || ''} 
                                  onChange={(e) => setNewSiteForm({ ...newSiteForm, roostType: e.target.value })} 
                                  style={{ ...styles.select, padding: '12px', fontSize: '16px' }}
                                >
                                  <option value="">-- Select type --</option>
                                  {ROOST_TYPES.map(type => <option key={type} value={type}>{type}</option>)}
                                </select>
                              </div>
                            </div>

                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', marginBottom: '16px' }}>
                              <div>
                                <label style={{ ...styles.label, fontSize: '15px' }}>Location on Structure</label>
                                <select 
                                  value={newSiteForm.roostLocation || ''} 
                                  onChange={(e) => setNewSiteForm({ ...newSiteForm, roostLocation: e.target.value })} 
                                  style={{ ...styles.select, padding: '12px', fontSize: '16px' }}
                                >
                                  <option value="">-- Select location --</option>
                                  {ROOST_LOCATIONS.map(loc => <option key={loc} value={loc}>{loc}</option>)}
                                </select>
                              </div>
                              <div>
                                <label style={{ ...styles.label, fontSize: '15px' }}>Structure used by people?</label>
                                <select 
                                  value={newSiteForm.structureUsedByPeople || ''} 
                                  onChange={(e) => setNewSiteForm({ ...newSiteForm, structureUsedByPeople: e.target.value })} 
                                  style={{ ...styles.select, padding: '12px', fontSize: '16px' }}
                                >
                                  <option value="">-- Select --</option>
                                  <option value="Yes">Yes</option>
                                  <option value="No">No</option>
                                </select>
                              </div>
                            </div>

                            <div style={{ display: 'flex', gap: '12px' }}>
                              <button 
                                onClick={() => handleAddSite(property.id)} 
                                style={{ ...styles.button, ...styles.buttonPrimary, padding: '10px 20px', fontSize: '16px' }}
                              >
                                üíæ Save Roost Site
                              </button>
                              <button 
                                onClick={() => { setAddingSiteToPropertyId(null); setNewSiteForm({}); }} 
                                style={{ ...styles.button, ...styles.buttonSecondary, padding: '10px 20px', fontSize: '16px' }}
                              >
                                Cancel
                              </button>
                            </div>
                          </div>
                        )}
                      </div>
                    </div>
                  );
                })
              )}

              {/* Unassigned Sites (from v1 import) */}
              {sites.filter(s => !s.propertyId).length > 0 && (
                <div style={{ marginTop: '32px' }}>
                  <h3 style={{ fontSize: '20px', color: '#dc3545', marginBottom: '12px' }}>‚ö†Ô∏è Unassigned Roost Sites</h3>
                  <p style={{ color: '#666', marginBottom: '16px' }}>These sites need to be assigned to a property. Click "Edit" to assign them.</p>
                  {sites.filter(s => !s.propertyId).map(site => (
                    <div key={site.id} style={{ ...styles.siteCard, borderColor: '#ffc107', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                      <strong>{site.name}</strong>
                      <button onClick={() => { setEditingSite(site); setView('editSite'); }} style={{ ...styles.button, ...styles.buttonPrimary, padding: '8px 16px', fontSize: '14px' }}>
                        Edit & Assign
                      </button>
                    </div>
                  ))}
                </div>
              )}
            </div>

            <button onClick={() => setView('appSettings')} style={{ ...styles.button, ...styles.buttonSecondary }}>‚Üê Back to Settings</button>
          </div>
        );
      };

      // ============ EDIT PROPERTY VIEW ============
      const EditPropertyView = () => {
        const [form, setForm] = useState(editingProperty || {});
        const isNew = !form.id;

        const handleSubmit = (e) => {
          e.preventDefault();
          if (!form.name) { showMessage('Please enter a property name', 'error'); return; }
          saveProperty(form);
        };

        return (
          <form onSubmit={handleSubmit}>
            <div style={styles.card}>
              <h2 style={styles.cardTitle}>{isNew ? 'Add New Property' : 'Edit Property'}</h2>

              <div style={styles.formGroup}>
                <label style={styles.label}>Property Name *</label>
                <input type="text" value={form.name || ''} onChange={(e) => setForm({ ...form, name: e.target.value })} style={styles.input} placeholder="e.g. Wickett Property, Smith Farm" />
                <p style={styles.helpText}>A memorable name for this property/landowner</p>
              </div>

              <div style={styles.formGroup}>
                <label style={styles.checkboxLabel}>
                  <input type="checkbox" checked={form.sameAsPrimary || false} onChange={(e) => setForm({ ...form, sameAsPrimary: e.target.checked })} style={styles.checkbox} />
                  Landowner is same as Primary Bat Counter (me)
                </label>
              </div>

              {!form.sameAsPrimary && (
                <>
                  <h3 style={{ fontSize: '20px', color: '#333', marginTop: '32px', marginBottom: '20px' }}>Landowner Information</h3>
                  
                  <div style={styles.formGroup}>
                    <label style={styles.label}>Landowner Name</label>
                    <input type="text" value={form.landownerName || ''} onChange={(e) => setForm({ ...form, landownerName: e.target.value })} style={styles.input} placeholder="e.g. Gary Wickett" />
                  </div>

                  <div style={styles.formGroup}>
                    <label style={styles.label}>Landowner Address</label>
                    <input type="text" value={form.landownerAddress || ''} onChange={(e) => setForm({ ...form, landownerAddress: e.target.value })} style={styles.input} placeholder="Street address, City, Province, Postal Code" />
                  </div>

                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px' }}>
                    <div style={styles.formGroup}>
                      <label style={styles.label}>Landowner Phone</label>
                      <input type="tel" value={form.landownerPhone || ''} onChange={(e) => setForm({ ...form, landownerPhone: e.target.value })} style={styles.input} placeholder="e.g. 250-555-1234" />
                    </div>
                    <div style={styles.formGroup}>
                      <label style={styles.label}>Landowner Email</label>
                      <input type="email" value={form.landownerEmail || ''} onChange={(e) => setForm({ ...form, landownerEmail: e.target.value })} style={styles.input} placeholder="e.g. gary@example.com" />
                    </div>
                  </div>
                </>
              )}

              <div style={styles.formGroup}>
                <label style={styles.label}>Notes</label>
                <textarea value={form.notes || ''} onChange={(e) => setForm({ ...form, notes: e.target.value })} style={styles.textarea} placeholder="Any notes about this property or landowner..." />
              </div>

              <h3 style={{ fontSize: '20px', color: '#333', marginTop: '32px', marginBottom: '20px' }}>üöó Mileage Tracking</h3>
              
              <div style={styles.formGroup}>
                <label style={styles.label}>Distance from Home (one-way km)</label>
                <input 
                  type="number" 
                  step="0.1"
                  value={form.distanceKm || ''} 
                  onChange={(e) => setForm({ ...form, distanceKm: e.target.value })} 
                  style={{ ...styles.input, maxWidth: '200px' }} 
                  placeholder="e.g. 4.5" 
                />
                <p style={styles.helpText}>
                  Distance from 83 Blue Heron Road to this property. Used to calculate round-trip mileage for volunteer expense tracking.
                </p>
              </div>
            </div>

            <div style={styles.buttonRow}>
              <button type="submit" style={{ ...styles.button, ...styles.buttonPrimary }}>üíæ Save Property</button>
              <button type="button" onClick={() => { setEditingProperty(null); setView('properties'); }} style={{ ...styles.button, ...styles.buttonSecondary }}>Cancel</button>
              {editingProperty?.id && (
                <button type="button" onClick={() => { deleteProperty(editingProperty.id); setEditingProperty(null); setView('properties'); }} style={{ ...styles.button, ...styles.buttonDanger }}>üóëÔ∏è Delete Property</button>
              )}
            </div>
          </form>
        );
      };

      // ============ EDIT SITE VIEW ============
      const EditSiteView = () => {
        const [form, setForm] = useState(editingSite || {});
        const isNew = !form.id;

        const handleSubmit = (e) => {
          e.preventDefault();
          if (!form.propertyId) { showMessage('Please select a property', 'error'); return; }
          if (!form.name) { showMessage('Please enter a site name', 'error'); return; }
          saveSite(form);
        };

        return (
          <form onSubmit={handleSubmit}>
            <div style={styles.card}>
              <h2 style={styles.cardTitle}>{isNew ? 'Add New Roost Site' : 'Edit Roost Site'}</h2>

              <div style={styles.formGroup}>
                <label style={styles.label}>Property *</label>
                <select value={form.propertyId || ''} onChange={(e) => setForm({ ...form, propertyId: e.target.value })} style={styles.select}>
                  <option value="">-- Select property --</option>
                  {properties.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                </select>
              </div>

              <div style={styles.infoBox}>
                <strong>Naming your site:</strong> Give your site a unique, memorable name 
                (e.g., "House Roof", "Bat Box #1", "Barn East Side"). If it has been counted before, use the same name.
              </div>

              <div style={styles.formGroup}>
                <label style={styles.label}>Site Name *</label>
                <input type="text" value={form.name || ''} onChange={(e) => setForm({ ...form, name: e.target.value })} style={styles.input} placeholder="e.g. House Roof, Bat Box #1, Barn" />
              </div>

              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px' }}>
                <div style={styles.formGroup}>
                  <label style={styles.label}>Roost Type</label>
                  <select value={form.roostType || ''} onChange={(e) => setForm({ ...form, roostType: e.target.value })} style={styles.select}>
                    <option value="">-- Select type --</option>
                    {ROOST_TYPES.map(type => <option key={type} value={type}>{type}</option>)}
                  </select>
                </div>
                <div style={styles.formGroup}>
                  <label style={styles.label}>Location on Structure</label>
                  <select value={form.roostLocation || ''} onChange={(e) => setForm({ ...form, roostLocation: e.target.value })} style={styles.select}>
                    <option value="">-- Select location --</option>
                    {ROOST_LOCATIONS.map(loc => <option key={loc} value={loc}>{loc}</option>)}
                  </select>
                </div>
              </div>

              <div style={styles.formGroup}>
                <label style={styles.label}>Structure used by people?</label>
                <div style={styles.radioGroup}>
                  <label style={styles.radioLabel}>
                    <input type="radio" name="structureUsed" checked={form.structureUsedByPeople === 'Yes'} onChange={() => setForm({ ...form, structureUsedByPeople: 'Yes' })} style={styles.radioInput} />
                    Yes
                  </label>
                  <label style={styles.radioLabel}>
                    <input type="radio" name="structureUsed" checked={form.structureUsedByPeople === 'No'} onChange={() => setForm({ ...form, structureUsedByPeople: 'No' })} style={styles.radioInput} />
                    No
                  </label>
                </div>
              </div>

              <div style={styles.formGroup}>
                <label style={styles.label}>GPS Coordinates (optional)</label>
                <input type="text" value={form.coordinates || ''} onChange={(e) => setForm({ ...form, coordinates: e.target.value })} style={styles.input} placeholder="e.g. 48.9834, -123.6729" />
                <p style={styles.helpText}>Enter as latitude, longitude. Will be converted to UTM for BC Bats export.</p>
              </div>

              <div style={styles.formGroup}>
                <label style={styles.label}>Notes</label>
                <textarea value={form.notes || ''} onChange={(e) => setForm({ ...form, notes: e.target.value })} style={styles.textarea} placeholder="Directions, access notes, number of exit points, etc." />
              </div>
            </div>

            <div style={styles.card}>
              <h2 style={styles.cardTitle}>ü¶á BC Bats Additional Info</h2>
              <p style={{ ...styles.helpText, marginBottom: '20px' }}>These fields are used in the BC Community Bat Program data export.</p>

              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px' }}>
                <div style={styles.formGroup}>
                  <label style={styles.label}>Inventory Method</label>
                  <select value={form.inventoryMethod || ''} onChange={(e) => setForm({ ...form, inventoryMethod: e.target.value })} style={styles.select}>
                    {INVENTORY_METHODS.map(method => <option key={method} value={method}>{method || '-- None --'}</option>)}
                  </select>
                  <p style={styles.helpText}>How bats are counted at this site</p>
                </div>
                <div style={styles.formGroup}>
                  <label style={styles.label}>Detect Type</label>
                  <select value={form.detectType || ''} onChange={(e) => setForm({ ...form, detectType: e.target.value })} style={styles.select}>
                    {DETECT_TYPES.map(type => <option key={type} value={type}>{type || '-- None --'}</option>)}
                  </select>
                  <p style={styles.helpText}>Equipment used (if acoustic)</p>
                </div>
              </div>

              <div style={styles.formGroup}>
                <label style={styles.label}>Eviction planned?</label>
                <div style={styles.radioGroup}>
                  <label style={styles.radioLabel}>
                    <input type="radio" name="eviction" checked={form.evictionPlanned === 'Yes'} onChange={() => setForm({ ...form, evictionPlanned: 'Yes' })} style={styles.radioInput} />
                    Yes
                  </label>
                  <label style={styles.radioLabel}>
                    <input type="radio" name="eviction" checked={form.evictionPlanned !== 'Yes'} onChange={() => setForm({ ...form, evictionPlanned: 'No' })} style={styles.radioInput} />
                    No
                  </label>
                </div>
              </div>

              <div style={styles.formGroup}>
                <label style={styles.label}>Renovation or Demolition planned?</label>
                <div style={styles.radioGroup}>
                  <label style={styles.radioLabel}>
                    <input type="radio" name="renovation" checked={form.renovationPlanned === 'Yes'} onChange={() => setForm({ ...form, renovationPlanned: 'Yes' })} style={styles.radioInput} />
                    Yes
                  </label>
                  <label style={styles.radioLabel}>
                    <input type="radio" name="renovation" checked={form.renovationPlanned !== 'Yes'} onChange={() => setForm({ ...form, renovationPlanned: 'No' })} style={styles.radioInput} />
                    No
                  </label>
                </div>
              </div>

              <div style={styles.formGroup}>
                <label style={styles.label}>Multiple Roosts monitored?</label>
                <div style={styles.radioGroup}>
                  <label style={styles.radioLabel}>
                    <input type="radio" name="multipleRoosts" checked={form.multipleRoosts === 'Yes'} onChange={() => setForm({ ...form, multipleRoosts: 'Yes' })} style={styles.radioInput} />
                    Yes
                  </label>
                  <label style={styles.radioLabel}>
                    <input type="radio" name="multipleRoosts" checked={form.multipleRoosts !== 'Yes'} onChange={() => setForm({ ...form, multipleRoosts: 'No' })} style={styles.radioInput} />
                    No
                  </label>
                </div>
              </div>
            </div>

            <div style={styles.buttonRow}>
              <button type="submit" style={{ ...styles.button, ...styles.buttonPrimary }}>üíæ Save Site</button>
              <button type="button" onClick={() => { setEditingSite(null); setView('properties'); }} style={{ ...styles.button, ...styles.buttonSecondary }}>Cancel</button>
              {editingSite?.id && (
                <button type="button" onClick={() => { deleteSite(editingSite.id); setEditingSite(null); setView('properties'); }} style={{ ...styles.button, ...styles.buttonDanger }}>üóëÔ∏è Delete Site</button>
              )}
            </div>
          </form>
        );
      };

      // ============ NEW COUNT FORM ============
      const NewCountForm = () => {
        const [step, setStep] = useState(1);
        const [sessionForm, setSessionForm] = useState({
          date: new Date().toISOString().split('T')[0],
          propertyId: '',
          countNumber: null, // null = auto-calculate, 1-4 = manual override
          startTime: '',
          firstBatTime: '',
          endTime: '',
          startTemp: '',
          rainCode: '',
          cloudCode: '',
          windCode: '',
          volunteerCount: '',
          species: '',
          sessionComments: ''
        });
        
        // Site counts: { [siteId]: { counter1Total, counter2Total, pupsSeenHeard, siteComment, skipped } }
        const [siteCounts, setSiteCounts] = useState({});

        const selectedProperty = properties.find(p => p.id === sessionForm.propertyId);
        const propertySites = selectedProperty ? getSitesForProperty(selectedProperty.id) : [];

        // Calculate suggested count number based on date and existing counts
        const calculateCountNumber = () => {
          if (!sessionForm.propertyId || !sessionForm.date) return null;
          
          const date = new Date(sessionForm.date + 'T00:00:00');
          const year = date.getFullYear();
          const month = date.getMonth();
          const day = date.getDate();
          
          // Get existing counts for this property this year
          const propertySiteIds = propertySites.map(s => s.id);
          const propertyCountsThisYear = counts.filter(c => {
            const countYear = new Date(c.date).getFullYear();
            return propertySiteIds.includes(c.siteId) && countYear === year;
          });
          
          // Get unique dates per window
          const juneDates = [...new Set(propertyCountsThisYear
            .filter(c => {
              const d = new Date(c.date + 'T00:00:00');
              return d.getMonth() === 5 && d.getDate() >= 1 && d.getDate() <= 21;
            })
            .map(c => c.date))];
          
          const julyAugDates = [...new Set(propertyCountsThisYear
            .filter(c => {
              const d = new Date(c.date + 'T00:00:00');
              return (d.getMonth() === 6 && d.getDate() >= 11) || 
                     (d.getMonth() === 7 && d.getDate() >= 1 && d.getDate() <= 5);
            })
            .map(c => c.date))];
          
          // Determine which window this date falls into
          const isJuneWindow = month === 5 && day >= 1 && day <= 21;
          const isJulyAugWindow = (month === 6 && day >= 11) || (month === 7 && day >= 1 && day <= 5);
          
          // Calculate suggested count number
          if (isJuneWindow) {
            return juneDates.length === 0 ? 1 : 2;
          } else if (isJulyAugWindow) {
            return julyAugDates.length === 0 ? 3 : 4;
          } else {
            // Outside ideal windows - suggest based on proximity
            if (month < 5) return 1; // Before June
            if (month === 5 && day > 21) return 2; // Late June
            if (month === 6 && day < 11) return 2; // Early July (gap between windows)
            if (month === 7 && day > 5) return 4; // After Aug 5
            if (month > 7) return 4; // After August
            return null;
          }
        };

        const getDateWindowInfo = () => {
          if (!sessionForm.date) return null;
          
          const date = new Date(sessionForm.date + 'T00:00:00');
          const month = date.getMonth();
          const day = date.getDate();
          
          const isJuneWindow = month === 5 && day >= 1 && day <= 21;
          const isJulyAugWindow = (month === 6 && day >= 11) || (month === 7 && day >= 1 && day <= 5);
          
          if (isJuneWindow) {
            return { inWindow: true, window: 'June 1-21', counts: '1 or 2' };
          } else if (isJulyAugWindow) {
            return { inWindow: true, window: 'July 11 - Aug 5', counts: '3 or 4' };
          } else {
            return { inWindow: false, window: null, counts: null };
          }
        };

        const suggestedCountNumber = calculateCountNumber();
        const effectiveCountNumber = sessionForm.countNumber !== null ? sessionForm.countNumber : suggestedCountNumber;
        const dateWindowInfo = getDateWindowInfo();

        // Initialize site counts when property changes
        React.useEffect(() => {
          if (sessionForm.propertyId && propertySites.length > 0) {
            const initial = {};
            propertySites.forEach(site => {
              initial[site.id] = {
                counter1Total: '',
                counter2Total: '',
                pupsSeenHeard: '',
                siteComment: '',
                skipped: false
              };
            });
            setSiteCounts(initial);
          }
        }, [sessionForm.propertyId]);

        const updateSiteCount = (siteId, field, value) => {
          setSiteCounts(prev => ({
            ...prev,
            [siteId]: { ...prev[siteId], [field]: value }
          }));
        };

        const handleStep1Submit = (e) => {
          e.preventDefault();
          if (!sessionForm.propertyId) { showMessage('Please select a property', 'error'); return; }
          if (!sessionForm.date) { showMessage('Please enter a date', 'error'); return; }
          setStep(2);
        };

        const handleFinalSubmit = (e) => {
          e.preventDefault();
          
          // Check at least one site is not skipped
          const countedSites = propertySites.filter(s => !siteCounts[s.id]?.skipped);
          if (countedSites.length === 0) {
            showMessage('Please record at least one roost site', 'error');
            return;
          }

          // Create one count record per non-skipped site
          const newCounts = countedSites.map(site => ({
            id: Date.now().toString() + '-' + site.id,
            siteId: site.id,
            date: sessionForm.date,
            countNumber: effectiveCountNumber, // Store the count number (1-4, 'Extra', or null)
            startTime: sessionForm.startTime,
            firstBatTime: sessionForm.firstBatTime,
            endTime: sessionForm.endTime,
            startTemp: sessionForm.startTemp,
            rainCode: sessionForm.rainCode,
            cloudCode: sessionForm.cloudCode,
            windCode: sessionForm.windCode,
            volunteerCount: sessionForm.volunteerCount,
            species: sessionForm.species,
            counter1Total: siteCounts[site.id]?.counter1Total || '0',
            counter2Total: siteCounts[site.id]?.counter2Total || '',
            pupsSeenHeard: siteCounts[site.id]?.pupsSeenHeard || 'Unknown',
            comments: [sessionForm.sessionComments, siteCounts[site.id]?.siteComment].filter(Boolean).join(' | ')
          }));

          setCounts([...counts, ...newCounts]);
          showMessage(`Saved ${newCounts.length} counting session${newCounts.length > 1 ? 's' : ''}!`);
          setView('home');
        };

        // Step 1: Property & Session Details
        if (step === 1) {
          return (
            <form onSubmit={handleStep1Submit}>
              <div style={styles.card}>
                <h2 style={styles.cardTitle}>ü¶á New Counting Session</h2>
                <p style={{ color: '#666', marginBottom: '24px' }}>Step 1 of 2: Session Details</p>

                <div style={styles.formGroup}>
                  <label style={styles.label}>Select Property *</label>
                  {properties.length === 0 ? (
                    <div style={styles.warningBox}>
                      No properties added yet.{' '}
                      <button type="button" onClick={() => setView('properties')} style={{ background: 'none', border: 'none', color: '#856404', textDecoration: 'underline', cursor: 'pointer', fontSize: 'inherit', fontFamily: 'inherit' }}>
                        Add a property first ‚Üí
                      </button>
                    </div>
                  ) : (
                    <select 
                      value={sessionForm.propertyId} 
                      onChange={(e) => setSessionForm({ ...sessionForm, propertyId: e.target.value })} 
                      style={styles.select}
                    >
                      <option value="">-- Choose a property --</option>
                      {properties.filter(p => getSitesForProperty(p.id).length > 0).map(p => (
                        <option key={p.id} value={p.id}>
                          {p.name} ({getSitesForProperty(p.id).length} site{getSitesForProperty(p.id).length !== 1 ? 's' : ''})
                        </option>
                      ))}
                    </select>
                  )}
                  {properties.length > 0 && properties.filter(p => getSitesForProperty(p.id).length > 0).length === 0 && (
                    <div style={{ ...styles.warningBox, marginTop: '12px' }}>
                      Properties exist but have no roost sites.{' '}
                      <button type="button" onClick={() => setView('properties')} style={{ background: 'none', border: 'none', color: '#856404', textDecoration: 'underline', cursor: 'pointer', fontSize: 'inherit', fontFamily: 'inherit' }}>
                        Add roost sites first ‚Üí
                      </button>
                    </div>
                  )}
                </div>

                <div style={styles.formGroup}>
                  <label style={styles.label}>Count Date *</label>
                  <input 
                    type="date" 
                    value={sessionForm.date} 
                    onChange={(e) => setSessionForm({ ...sessionForm, date: e.target.value, countNumber: null })} 
                    style={styles.input} 
                  />
                </div>

                {/* Count Number Indicator */}
                {sessionForm.propertyId && sessionForm.date && (
                  <div style={{ 
                    backgroundColor: dateWindowInfo?.inWindow ? '#e8f5e9' : '#fff3cd', 
                    border: `1px solid ${dateWindowInfo?.inWindow ? colors.moss : '#ffc107'}`,
                    borderRadius: '8px', 
                    padding: '16px 20px', 
                    marginBottom: '24px' 
                  }}>
                    <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', flexWrap: 'wrap', gap: '12px' }}>
                      <div>
                        <div style={{ fontSize: '16px', fontWeight: '600', color: colors.forest, marginBottom: '4px' }}>
                          {effectiveCountNumber === 'Extra' ? (
                            <>üìÖ This is an <strong>Extra Count</strong> for {selectedProperty?.name}</>
                          ) : dateWindowInfo?.inWindow ? (
                            <>üìÖ This is <strong>Count #{effectiveCountNumber}</strong> for {selectedProperty?.name}</>
                          ) : (
                            <>‚ö†Ô∏è Date is outside ideal counting windows</>
                          )}
                        </div>
                        <div style={{ fontSize: '14px', color: colors.textLight }}>
                          {effectiveCountNumber === 'Extra' ? (
                            <>Extra counts don't affect season progress tracking</>
                          ) : dateWindowInfo?.inWindow ? (
                            <>Window: {dateWindowInfo.window} (Counts #{dateWindowInfo.counts})</>
                          ) : (
                            <>Ideal windows: Jun 1-21 (Counts #1-2) and Jul 11 - Aug 5 (Counts #3-4)</>
                          )}
                        </div>
                      </div>
                      <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                        <label style={{ fontSize: '14px', color: colors.textLight }}>Count #:</label>
                        <select 
                          value={sessionForm.countNumber !== null ? sessionForm.countNumber : (suggestedCountNumber || '')}
                          onChange={(e) => {
                            const val = e.target.value;
                            // If they select the suggested value, treat as auto
                            if (parseInt(val) === suggestedCountNumber) {
                              setSessionForm({ ...sessionForm, countNumber: null });
                            } else {
                              setSessionForm({ ...sessionForm, countNumber: val === 'Extra' ? 'Extra' : parseInt(val) });
                            }
                          }}
                          style={{ ...styles.select, width: 'auto', minWidth: '80px', padding: '8px 12px', fontSize: '16px' }}
                        >
                          <option value="1">1</option>
                          <option value="2">2</option>
                          <option value="3">3</option>
                          <option value="4">4</option>
                          <option value="Extra">Extra</option>
                        </select>
                        {sessionForm.countNumber !== null && sessionForm.countNumber !== suggestedCountNumber && (
                          <button 
                            type="button"
                            onClick={() => setSessionForm({ ...sessionForm, countNumber: null })}
                            style={{ 
                              background: 'none', 
                              border: 'none', 
                              color: colors.sage, 
                              cursor: 'pointer', 
                              fontSize: '13px',
                              textDecoration: 'underline'
                            }}
                          >
                            Reset to auto
                          </button>
                        )}
                      </div>
                    </div>
                  </div>
                )}

                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '20px' }}>
                  <div style={styles.formGroup}>
                    <label style={styles.label}>Start Time (sunset)</label>
                    <input type="time" value={sessionForm.startTime} onChange={(e) => setSessionForm({ ...sessionForm, startTime: e.target.value })} style={styles.input} />
                    <p style={styles.helpText}>Arrive by sunset</p>
                  </div>
                  <div style={styles.formGroup}>
                    <label style={styles.label}>First Bat Time</label>
                    <input type="time" value={sessionForm.firstBatTime} onChange={(e) => setSessionForm({ ...sessionForm, firstBatTime: e.target.value })} style={styles.input} />
                    <p style={styles.helpText}>When first bat emerged</p>
                  </div>
                  <div style={styles.formGroup}>
                    <label style={styles.label}>End Time</label>
                    <input type="time" value={sessionForm.endTime} onChange={(e) => setSessionForm({ ...sessionForm, endTime: e.target.value })} style={styles.input} />
                    <p style={styles.helpText}>Count for ~1 hour</p>
                  </div>
                </div>

                <div style={styles.formGroup}>
                  <label style={styles.label}>Start Temperature (¬∞C)</label>
                  <input 
                    type="number" 
                    value={sessionForm.startTemp} 
                    onChange={(e) => setSessionForm({ ...sessionForm, startTemp: e.target.value })} 
                    style={{ ...styles.input, maxWidth: '200px' }} 
                    placeholder="e.g. 15" 
                  />
                  <p style={styles.helpText}>Temperature should be at least 12¬∞C ‚Äì bats may not fly if too cold</p>
                </div>
              </div>

              <div style={styles.card}>
                <h2 style={styles.cardTitle}>Weather Conditions</h2>
                <div style={styles.tipBox}>
                  <strong>üí° Tip:</strong> Codes 1‚Äì3 are best for counting. Code 4 is marginal. 
                  Avoid surveying if conditions are worse than 4.
                </div>

                <div style={styles.formGroup}>
                  <label style={styles.label}>Rain (Precipitation)</label>
                  <CodeButtonGroup codes={RAIN_CODES} value={sessionForm.rainCode} onChange={(code) => setSessionForm({ ...sessionForm, rainCode: code })} />
                </div>

                <div style={styles.formGroup}>
                  <label style={styles.label}>Cloud Cover</label>
                  <CodeButtonGroup codes={CLOUD_CODES} value={sessionForm.cloudCode} onChange={(code) => setSessionForm({ ...sessionForm, cloudCode: code })} />
                </div>

                <div style={styles.formGroup}>
                  <label style={styles.label}>Wind</label>
                  <CodeButtonGroup codes={WIND_CODES} value={sessionForm.windCode} onChange={(code) => setSessionForm({ ...sessionForm, windCode: code })} />
                </div>
              </div>

              <div style={styles.card}>
                <h2 style={styles.cardTitle}>Additional Details</h2>

                <div style={styles.formGroup}>
                  <label style={styles.label}>Number of Volunteers</label>
                  <input 
                    type="number" 
                    value={sessionForm.volunteerCount} 
                    onChange={(e) => setSessionForm({ ...sessionForm, volunteerCount: e.target.value })} 
                    style={{ ...styles.input, maxWidth: '200px' }} 
                    placeholder="1" 
                    min="1" 
                  />
                </div>

                <div style={styles.formGroup}>
                  <label style={styles.label}>Species (if known)</label>
                  <select value={sessionForm.species} onChange={(e) => setSessionForm({ ...sessionForm, species: e.target.value })} style={styles.select}>
                    <option value="">-- Select species --</option>
                    {BAT_SPECIES.map(species => <option key={species} value={species}>{species}</option>)}
                  </select>
                </div>

                <div style={styles.formGroup}>
                  <label style={styles.label}>Session Comments</label>
                  <textarea 
                    value={sessionForm.sessionComments} 
                    onChange={(e) => setSessionForm({ ...sessionForm, sessionComments: e.target.value })} 
                    style={styles.textarea} 
                    placeholder="General notes about this count session (weather events, smoke, etc.)" 
                  />
                </div>
              </div>

              <div style={styles.buttonRow}>
                <button type="submit" style={{ ...styles.button, ...styles.buttonPrimary }}>Next: Enter Counts ‚Üí</button>
                <button type="button" onClick={() => setView('home')} style={{ ...styles.button, ...styles.buttonSecondary }}>Cancel</button>
              </div>
            </form>
          );
        }

        // Step 2: Site Counts
        return (
          <form onSubmit={handleFinalSubmit}>
            <div style={styles.card}>
              <h2 style={styles.cardTitle}>ü¶á Enter New Count</h2>
              <p style={{ color: '#666', marginBottom: '8px' }}>Step 2 of 2: Roost Site Counts</p>
              
              <div style={{ backgroundColor: '#e8f5e9', padding: '16px', borderRadius: '8px', marginBottom: '24px' }}>
                <strong>{selectedProperty?.name}</strong> ‚Ä¢ {sessionForm.date} ‚Ä¢ {propertySites.length} roost site{propertySites.length !== 1 ? 's' : ''}
              </div>

              <div style={styles.infoBox}>
                <strong>Two independent counters?</strong> If possible, have 2 counters do independent counts at the same exit 
                without sharing results. Counter 1 is used for totals; Counter 2 provides validation data for BC Bats.
              </div>
            </div>

            {propertySites.map((site, index) => {
              const siteData = siteCounts[site.id] || {};
              const isSkipped = siteData.skipped;
              
              return (
                <div key={site.id} style={{ ...styles.card, opacity: isSkipped ? 0.6 : 1, backgroundColor: isSkipped ? '#f5f5f5' : 'white' }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
                    <h3 style={{ margin: 0, fontSize: '20px', color: '#2c5530' }}>
                      {index + 1}. {site.name}
                    </h3>
                    <label style={{ ...styles.checkboxLabel, backgroundColor: isSkipped ? '#ffebee' : '#f8f9fa' }}>
                      <input 
                        type="checkbox" 
                        checked={isSkipped} 
                        onChange={(e) => updateSiteCount(site.id, 'skipped', e.target.checked)} 
                        style={styles.checkbox} 
                      />
                      Not counted
                    </label>
                  </div>
                  
                  {site.roostType && (
                    <p style={{ color: '#666', fontSize: '14px', margin: '-8px 0 16px 0' }}>
                      {site.roostType} {site.roostLocation && `‚Ä¢ ${site.roostLocation}`}
                    </p>
                  )}

                  {!isSkipped && (
                    <>
                      <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px', marginBottom: '20px' }}>
                        <div style={styles.formGroup}>
                          <label style={styles.label}>Counter 1 (Primary) *</label>
                          <input 
                            type="number" 
                            value={siteData.counter1Total || ''} 
                            onChange={(e) => updateSiteCount(site.id, 'counter1Total', e.target.value)} 
                            style={styles.input} 
                            placeholder="0" 
                            min="0" 
                          />
                        </div>
                        <div style={styles.formGroup}>
                          <label style={styles.label}>Counter 2 (Validation)</label>
                          <input 
                            type="number" 
                            value={siteData.counter2Total || ''} 
                            onChange={(e) => updateSiteCount(site.id, 'counter2Total', e.target.value)} 
                            style={styles.input} 
                            placeholder="0" 
                            min="0" 
                          />
                        </div>
                      </div>

                      <div style={styles.formGroup}>
                        <label style={styles.label}>Pups Seen or Heard?</label>
                        <div style={styles.radioGroup}>
                          <label style={styles.radioLabel}>
                            <input 
                              type="radio" 
                              name={`pups-${site.id}`} 
                              checked={siteData.pupsSeenHeard === 'Yes'} 
                              onChange={() => updateSiteCount(site.id, 'pupsSeenHeard', 'Yes')} 
                              style={styles.radioInput} 
                            />
                            Yes
                          </label>
                          <label style={styles.radioLabel}>
                            <input 
                              type="radio" 
                              name={`pups-${site.id}`} 
                              checked={siteData.pupsSeenHeard === 'No'} 
                              onChange={() => updateSiteCount(site.id, 'pupsSeenHeard', 'No')} 
                              style={styles.radioInput} 
                            />
                            No
                          </label>
                          <label style={styles.radioLabel}>
                            <input 
                              type="radio" 
                              name={`pups-${site.id}`} 
                              checked={siteData.pupsSeenHeard === 'Unknown'} 
                              onChange={() => updateSiteCount(site.id, 'pupsSeenHeard', 'Unknown')} 
                              style={styles.radioInput} 
                            />
                            Unknown
                          </label>
                        </div>
                      </div>

                      <div style={styles.formGroup}>
                        <label style={styles.label}>Site Comment (optional)</label>
                        <input 
                          type="text" 
                          value={siteData.siteComment || ''} 
                          onChange={(e) => updateSiteCount(site.id, 'siteComment', e.target.value)} 
                          style={styles.input} 
                          placeholder="Any notes specific to this roost site" 
                        />
                      </div>
                    </>
                  )}
                </div>
              );
            })}

            <div style={styles.buttonRow}>
              <button type="submit" style={{ ...styles.button, ...styles.buttonPrimary }}>üíæ Save Counting Session</button>
              <button type="button" onClick={() => setStep(1)} style={{ ...styles.button, ...styles.buttonSecondary }}>‚Üê Back</button>
              <button type="button" onClick={() => setView('home')} style={{ ...styles.button, ...styles.buttonSecondary }}>Cancel</button>
            </div>
          </form>
        );
      };

      // ============ HISTORY VIEW ============
      const HistoryView = () => {
        const currentYear = new Date().getFullYear();
        const [filterPropertyId, setFilterPropertyId] = useState('');
        const [filterYear, setFilterYear] = useState(currentYear.toString());

        const years = [...new Set(counts.map(c => new Date(c.date).getFullYear()))].sort((a, b) => b - a);

        // Group counts by property and date
        const groupedCounts = {};
        counts.forEach(count => {
          const site = sites.find(s => s.id === count.siteId);
          const property = site ? properties.find(p => p.id === site.propertyId) : null;
          const propertyId = property?.id || 'unknown';
          const key = `${count.date}-${propertyId}`;
          
          if (!groupedCounts[key]) {
            groupedCounts[key] = {
              date: count.date,
              property: property,
              propertyId: propertyId,
              counts: [],
              totalBats: 0
            };
          }
          groupedCounts[key].counts.push(count);
          groupedCounts[key].totalBats += parseInt(count.counter1Total) || 0; // Counter 1 only
        });

        // Convert to array and filter
        const groupedArray = Object.values(groupedCounts)
          .filter(g => !filterPropertyId || g.propertyId === filterPropertyId)
          .filter(g => !filterYear || new Date(g.date).getFullYear() === parseInt(filterYear))
          .sort((a, b) => new Date(b.date) - new Date(a.date));

        const handleEditGroup = (group) => {
          // Store the group info for editing
          setEditingCount({
            date: group.date,
            propertyId: group.propertyId,
            counts: group.counts
          });
          setView('editCount');
        };

        return (
          <div>
            <div style={styles.card}>
              <h2 style={styles.cardTitle}>üìì Counting Session Log</h2>

              <div style={{ display: 'flex', gap: '20px', marginBottom: '24px', flexWrap: 'wrap' }}>
                <div>
                  <label style={{ ...styles.label, fontSize: '16px' }}>Filter by Property</label>
                  <select value={filterPropertyId} onChange={(e) => setFilterPropertyId(e.target.value)} style={{ ...styles.select, width: 'auto', minWidth: '200px' }}>
                    <option value="">All Properties</option>
                    {properties.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                  </select>
                </div>
                <div>
                  <label style={{ ...styles.label, fontSize: '16px' }}>Filter by Year</label>
                  <select value={filterYear} onChange={(e) => setFilterYear(e.target.value)} style={{ ...styles.select, width: 'auto', minWidth: '150px' }}>
                    <option value="">All Years</option>
                    {years.map(year => <option key={year} value={year}>{year}</option>)}
                  </select>
                </div>
              </div>

              {groupedArray.length === 0 ? (
                <div style={styles.emptyState}><p>No counting sessions recorded yet.</p></div>
              ) : (
              <>
                <table style={styles.table}>
                  <thead>
                    <tr>
                      <th style={styles.th}>Date</th>
                      <th style={styles.th}>Property</th>
                      <th style={styles.th}>Sites</th>
                      <th style={styles.th}>Total Bats</th>
                      <th style={styles.th}>Count #</th>
                      <th style={styles.th}>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {groupedArray.map((group, idx) => {
                      // Get stored count number from first count in group, or fall back to calculated
                      const storedCountNumber = group.counts[0]?.countNumber;
                      let countNum = '‚Äî';
                      
                      if (storedCountNumber) {
                        // Use stored value
                        countNum = storedCountNumber === 'Extra' ? 'Extra' : `#${storedCountNumber}`;
                      } else {
                        // Fall back to calculation for legacy data without stored countNumber
                        const slot = getSeasonSlot(group.date);
                        const year = new Date(group.date).getFullYear();
                        const propertyCountsThisYear = groupedArray
                          .filter(g => g.propertyId === group.propertyId && new Date(g.date).getFullYear() === year)
                          .sort((a, b) => new Date(a.date) - new Date(b.date));
                        
                        const juneCounts = propertyCountsThisYear.filter(g => getSeasonSlot(g.date) === 'june');
                        const julyAugCounts = propertyCountsThisYear.filter(g => getSeasonSlot(g.date) === 'julyAug');
                        
                        if (slot === 'june') {
                          const juneIndex = juneCounts.findIndex(g => g.date === group.date);
                          countNum = juneIndex === 0 ? '#1' : juneIndex === 1 ? '#2' : `#${juneIndex + 1}`;
                        } else if (slot === 'julyAug') {
                          const julyAugIndex = julyAugCounts.findIndex(g => g.date === group.date);
                          countNum = julyAugIndex === 0 ? '#3' : julyAugIndex === 1 ? '#4' : `#${julyAugIndex + 3}`;
                        }
                      }
                      
                      return (
                        <tr key={idx}>
                          <td style={styles.td}>{formatDate(group.date)}</td>
                          <td style={styles.td}>{group.property?.name || 'Unknown'}</td>
                          <td style={styles.td}>{group.counts.length}</td>
                          <td style={styles.td}><strong>{group.totalBats}</strong></td>
                          <td style={styles.td}>{countNum}</td>
                          <td style={styles.td}>
                            <button onClick={() => handleEditGroup(group)} style={{ ...styles.button, ...styles.buttonSecondary, padding: '8px 12px', fontSize: '14px' }}>Edit</button>
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
                <p style={{ ...styles.helpText, marginTop: '12px', textAlign: 'center' }}>
                  Totals use Counter 1. Counter 2 is recorded for BC Bats data validation.
                </p>
              </>
              )}
            </div>

            <button onClick={() => setView('appSettings')} style={{ ...styles.button, ...styles.buttonSecondary }}>‚Üê Back to Settings</button>
          </div>
        );
      };

      // ============ EDIT COUNT VIEW ============
      const EditCountView = () => {
        // editingCount contains: { date, propertyId, counts: [...] }
        const existingCounts = editingCount?.counts || [];
        const propertyId = editingCount?.propertyId;
        const selectedProperty = properties.find(p => p.id === propertyId);
        const propertySites = selectedProperty ? getSitesForProperty(selectedProperty.id) : [];

        // Get shared session data from first count
        const firstCount = existingCounts[0] || {};
        
        const [sessionForm, setSessionForm] = useState({
          date: editingCount?.date || '',
          countNumber: null, // null = auto-calculate, 1-4 or 'Extra' = manual override
          startTime: firstCount.startTime || '',
          firstBatTime: firstCount.firstBatTime || '',
          endTime: firstCount.endTime || '',
          startTemp: firstCount.startTemp || '',
          rainCode: firstCount.rainCode || '',
          cloudCode: firstCount.cloudCode || '',
          windCode: firstCount.windCode || '',
          volunteerCount: firstCount.volunteerCount || '',
          species: firstCount.species || '',
          sessionComments: '' // Session-level comments
        });

        // Calculate suggested count number based on date and existing counts
        const calculateCountNumber = () => {
          if (!propertyId || !sessionForm.date) return null;
          
          const date = new Date(sessionForm.date + 'T00:00:00');
          const year = date.getFullYear();
          const month = date.getMonth();
          const day = date.getDate();
          
          // Get existing counts for this property this year (excluding current session's counts)
          const currentCountIds = existingCounts.map(c => c.id);
          const propertySiteIds = propertySites.map(s => s.id);
          const propertyCountsThisYear = counts.filter(c => {
            const countYear = new Date(c.date).getFullYear();
            return propertySiteIds.includes(c.siteId) && countYear === year && !currentCountIds.includes(c.id);
          });
          
          // Get unique dates per window
          const juneDates = [...new Set(propertyCountsThisYear
            .filter(c => {
              const d = new Date(c.date + 'T00:00:00');
              return d.getMonth() === 5 && d.getDate() >= 1 && d.getDate() <= 21;
            })
            .map(c => c.date))];
          
          const julyAugDates = [...new Set(propertyCountsThisYear
            .filter(c => {
              const d = new Date(c.date + 'T00:00:00');
              return (d.getMonth() === 6 && d.getDate() >= 11) || 
                     (d.getMonth() === 7 && d.getDate() >= 1 && d.getDate() <= 5);
            })
            .map(c => c.date))];
          
          // Determine which window this date falls into
          const isJuneWindow = month === 5 && day >= 1 && day <= 21;
          const isJulyAugWindow = (month === 6 && day >= 11) || (month === 7 && day >= 1 && day <= 5);
          
          // Calculate suggested count number
          if (isJuneWindow) {
            return juneDates.length === 0 ? 1 : 2;
          } else if (isJulyAugWindow) {
            return julyAugDates.length === 0 ? 3 : 4;
          } else {
            // Outside ideal windows - suggest based on proximity
            if (month < 5) return 1; // Before June
            if (month === 5 && day > 21) return 2; // Late June
            if (month === 6 && day < 11) return 2; // Early July (gap between windows)
            if (month === 7 && day > 5) return 4; // After Aug 5
            if (month > 7) return 4; // After August
            return null;
          }
        };

        const getDateWindowInfo = () => {
          if (!sessionForm.date) return null;
          
          const date = new Date(sessionForm.date + 'T00:00:00');
          const month = date.getMonth();
          const day = date.getDate();
          
          const isJuneWindow = month === 5 && day >= 1 && day <= 21;
          const isJulyAugWindow = (month === 6 && day >= 11) || (month === 7 && day >= 1 && day <= 5);
          
          if (isJuneWindow) {
            return { inWindow: true, window: 'June 1-21', counts: '1 or 2' };
          } else if (isJulyAugWindow) {
            return { inWindow: true, window: 'July 11 - Aug 5', counts: '3 or 4' };
          } else {
            return { inWindow: false, window: null, counts: null };
          }
        };

        const suggestedCountNumber = calculateCountNumber();
        const effectiveCountNumber = sessionForm.countNumber !== null ? sessionForm.countNumber : suggestedCountNumber;
        const dateWindowInfo = getDateWindowInfo();

        // Initialize site counts from existing counts
        const [siteCounts, setSiteCounts] = useState(() => {
          const initial = {};
          propertySites.forEach(site => {
            const existingCount = existingCounts.find(c => c.siteId === site.id);
            if (existingCount) {
              initial[site.id] = {
                countId: existingCount.id,
                counter1Total: existingCount.counter1Total || '',
                counter2Total: existingCount.counter2Total || '',
                pupsSeenHeard: existingCount.pupsSeenHeard || '',
                siteComment: existingCount.comments || '',
                skipped: false
              };
            } else {
              initial[site.id] = {
                countId: null,
                counter1Total: '',
                counter2Total: '',
                pupsSeenHeard: '',
                siteComment: '',
                skipped: true
              };
            }
          });
          return initial;
        });

        const updateSiteCount = (siteId, field, value) => {
          setSiteCounts(prev => ({
            ...prev,
            [siteId]: { ...prev[siteId], [field]: value }
          }));
        };

        const handleSubmit = (e) => {
          e.preventDefault();
          
          // Check at least one site is not skipped
          const countedSites = propertySites.filter(s => !siteCounts[s.id]?.skipped);
          if (countedSites.length === 0) {
            showMessage('Please record at least one roost site', 'error');
            return;
          }

          // Build updated counts array
          const updatedCounts = [];
          const newCounts = [];
          const deletedCountIds = [];

          propertySites.forEach(site => {
            const siteData = siteCounts[site.id];
            if (siteData.skipped) {
              // If it was previously counted but now skipped, mark for deletion
              if (siteData.countId) {
                deletedCountIds.push(siteData.countId);
              }
            } else {
              const countRecord = {
                siteId: site.id,
                date: sessionForm.date,
                countNumber: effectiveCountNumber, // Store the count number (1-4, 'Extra', or null)
                startTime: sessionForm.startTime,
                firstBatTime: sessionForm.firstBatTime,
                endTime: sessionForm.endTime,
                startTemp: sessionForm.startTemp,
                rainCode: sessionForm.rainCode,
                cloudCode: sessionForm.cloudCode,
                windCode: sessionForm.windCode,
                volunteerCount: sessionForm.volunteerCount,
                species: sessionForm.species,
                counter1Total: siteData.counter1Total || '0',
                counter2Total: siteData.counter2Total || '',
                pupsSeenHeard: siteData.pupsSeenHeard || 'Unknown',
                comments: siteData.siteComment || ''
              };

              if (siteData.countId) {
                // Update existing
                updatedCounts.push({ ...countRecord, id: siteData.countId, updatedAt: new Date().toISOString() });
              } else {
                // Create new
                newCounts.push({ ...countRecord, id: Date.now().toString() + '-' + site.id, createdAt: new Date().toISOString() });
              }
            }
          });

          // Apply changes to counts state
          let newCountsState = counts
            .filter(c => !deletedCountIds.includes(c.id))
            .map(c => {
              const updated = updatedCounts.find(u => u.id === c.id);
              return updated || c;
            });
          newCountsState = [...newCountsState, ...newCounts];

          setCounts(newCountsState);
          showMessage('Counts updated!');
          setEditingCount(null);
          setView('history');
        };

        const handleDeleteAll = () => {
          const countIds = existingCounts.map(c => c.id);
          if (window.confirm(`Delete all ${countIds.length} count record(s) from this session? This cannot be undone.`)) {
            setCounts(counts.filter(c => !countIds.includes(c.id)));
            showMessage('Counts deleted');
            setEditingCount(null);
            setView('history');
          }
        };

        if (!selectedProperty) {
          return (
            <div style={styles.card}>
              <h2 style={styles.cardTitle}>Error</h2>
              <p>Could not find property data.</p>
              <button onClick={() => setView('history')} style={{ ...styles.button, ...styles.buttonSecondary }}>‚Üê Back to History</button>
            </div>
          );
        }

        return (
          <form onSubmit={handleSubmit}>
            <div style={styles.card}>
              <h2 style={styles.cardTitle}>‚úèÔ∏è Edit Count Session</h2>
              
              <div style={{ backgroundColor: '#e8f5e9', padding: '16px', borderRadius: '8px', marginBottom: '24px' }}>
                <strong>{selectedProperty.name}</strong> ‚Ä¢ {propertySites.length} roost site{propertySites.length !== 1 ? 's' : ''}
              </div>

              <div style={styles.formGroup}>
                <label style={styles.label}>Count Date *</label>
                <input 
                  type="date" 
                  value={sessionForm.date} 
                  onChange={(e) => setSessionForm({ ...sessionForm, date: e.target.value, countNumber: null })} 
                  style={styles.input} 
                />
              </div>

              {/* Count Number Indicator */}
              {sessionForm.date && (
                <div style={{ 
                  backgroundColor: dateWindowInfo?.inWindow ? '#e8f5e9' : '#fff3cd', 
                  border: `1px solid ${dateWindowInfo?.inWindow ? colors.moss : '#ffc107'}`,
                  borderRadius: '8px', 
                  padding: '16px 20px', 
                  marginBottom: '24px' 
                }}>
                  <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', flexWrap: 'wrap', gap: '12px' }}>
                    <div>
                      <div style={{ fontSize: '16px', fontWeight: '600', color: colors.forest, marginBottom: '4px' }}>
                        {effectiveCountNumber === 'Extra' ? (
                          <>üìÖ This is an <strong>Extra Count</strong> for {selectedProperty?.name}</>
                        ) : dateWindowInfo?.inWindow ? (
                          <>üìÖ This is <strong>Count #{effectiveCountNumber}</strong> for {selectedProperty?.name}</>
                        ) : (
                          <>‚ö†Ô∏è Date is outside ideal counting windows</>
                        )}
                      </div>
                      <div style={{ fontSize: '14px', color: colors.textLight }}>
                        {effectiveCountNumber === 'Extra' ? (
                          <>Extra counts don't affect season progress tracking</>
                        ) : dateWindowInfo?.inWindow ? (
                          <>Window: {dateWindowInfo.window} (Counts #{dateWindowInfo.counts})</>
                        ) : (
                          <>Ideal windows: Jun 1-21 (Counts #1-2) and Jul 11 - Aug 5 (Counts #3-4)</>
                        )}
                      </div>
                    </div>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                      <label style={{ fontSize: '14px', color: colors.textLight }}>Count #:</label>
                      <select 
                        value={sessionForm.countNumber !== null ? sessionForm.countNumber : (suggestedCountNumber || '')}
                        onChange={(e) => {
                          const val = e.target.value;
                          // If they select the suggested value, treat as auto
                          if (parseInt(val) === suggestedCountNumber) {
                            setSessionForm({ ...sessionForm, countNumber: null });
                          } else {
                            setSessionForm({ ...sessionForm, countNumber: val === 'Extra' ? 'Extra' : parseInt(val) });
                          }
                        }}
                        style={{ ...styles.select, width: 'auto', minWidth: '80px', padding: '8px 12px', fontSize: '16px' }}
                      >
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="Extra">Extra</option>
                      </select>
                      {sessionForm.countNumber !== null && sessionForm.countNumber !== suggestedCountNumber && (
                        <button 
                          type="button"
                          onClick={() => setSessionForm({ ...sessionForm, countNumber: null })}
                          style={{ 
                            background: 'none', 
                            border: 'none', 
                            color: colors.sage, 
                            cursor: 'pointer', 
                            fontSize: '13px',
                            textDecoration: 'underline'
                          }}
                        >
                          Reset to auto
                        </button>
                      )}
                    </div>
                  </div>
                </div>
              )}

              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '20px' }}>
                <div style={styles.formGroup}>
                  <label style={styles.label}>Start Time</label>
                  <input type="time" value={sessionForm.startTime} onChange={(e) => setSessionForm({ ...sessionForm, startTime: e.target.value })} style={styles.input} />
                </div>
                <div style={styles.formGroup}>
                  <label style={styles.label}>First Bat Time</label>
                  <input type="time" value={sessionForm.firstBatTime} onChange={(e) => setSessionForm({ ...sessionForm, firstBatTime: e.target.value })} style={styles.input} />
                </div>
                <div style={styles.formGroup}>
                  <label style={styles.label}>End Time</label>
                  <input type="time" value={sessionForm.endTime} onChange={(e) => setSessionForm({ ...sessionForm, endTime: e.target.value })} style={styles.input} />
                </div>
              </div>

              <div style={styles.formGroup}>
                <label style={styles.label}>Start Temperature (¬∞C)</label>
                <input 
                  type="number" 
                  value={sessionForm.startTemp} 
                  onChange={(e) => setSessionForm({ ...sessionForm, startTemp: e.target.value })} 
                  style={{ ...styles.input, maxWidth: '200px' }} 
                  placeholder="e.g. 15" 
                />
              </div>
            </div>

            <div style={styles.card}>
              <h2 style={styles.cardTitle}>Weather Conditions</h2>

              <div style={styles.formGroup}>
                <label style={styles.label}>Rain (Precipitation)</label>
                <CodeButtonGroup codes={RAIN_CODES} value={sessionForm.rainCode} onChange={(code) => setSessionForm({ ...sessionForm, rainCode: code })} />
              </div>

              <div style={styles.formGroup}>
                <label style={styles.label}>Cloud Cover</label>
                <CodeButtonGroup codes={CLOUD_CODES} value={sessionForm.cloudCode} onChange={(code) => setSessionForm({ ...sessionForm, cloudCode: code })} />
              </div>

              <div style={styles.formGroup}>
                <label style={styles.label}>Wind</label>
                <CodeButtonGroup codes={WIND_CODES} value={sessionForm.windCode} onChange={(code) => setSessionForm({ ...sessionForm, windCode: code })} />
              </div>
            </div>

            <div style={styles.card}>
              <h2 style={styles.cardTitle}>Additional Details</h2>

              <div style={styles.formGroup}>
                <label style={styles.label}>Number of Volunteers</label>
                <input 
                  type="number" 
                  value={sessionForm.volunteerCount} 
                  onChange={(e) => setSessionForm({ ...sessionForm, volunteerCount: e.target.value })} 
                  style={{ ...styles.input, maxWidth: '200px' }} 
                  placeholder="1" 
                  min="1" 
                />
              </div>

              <div style={styles.formGroup}>
                <label style={styles.label}>Species (if known)</label>
                <select value={sessionForm.species} onChange={(e) => setSessionForm({ ...sessionForm, species: e.target.value })} style={styles.select}>
                  <option value="">-- Select species --</option>
                  {BAT_SPECIES.map(species => <option key={species} value={species}>{species}</option>)}
                </select>
              </div>

              <div style={styles.formGroup}>
                <label style={styles.label}>Session Comments</label>
                <textarea 
                  value={sessionForm.sessionComments} 
                  onChange={(e) => setSessionForm({ ...sessionForm, sessionComments: e.target.value })} 
                  style={styles.textarea} 
                  placeholder="General notes about this count session (weather events, smoke, etc.)" 
                />
              </div>
            </div>

            {/* Roost Site Counts */}
            <div style={styles.card}>
              <h2 style={styles.cardTitle}>ü¶á Roost Site Counts</h2>
            </div>

            {propertySites.map((site, index) => {
              const siteData = siteCounts[site.id] || {};
              const isSkipped = siteData.skipped;
              
              return (
                <div key={site.id} style={{ ...styles.card, opacity: isSkipped ? 0.6 : 1, backgroundColor: isSkipped ? '#f5f5f5' : 'white' }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
                    <h3 style={{ margin: 0, fontSize: '20px', color: '#2c5530' }}>
                      {index + 1}. {site.name}
                    </h3>
                    <label style={{ ...styles.checkboxLabel, backgroundColor: isSkipped ? '#ffebee' : '#f8f9fa' }}>
                      <input 
                        type="checkbox" 
                        checked={isSkipped} 
                        onChange={(e) => updateSiteCount(site.id, 'skipped', e.target.checked)} 
                        style={styles.checkbox} 
                      />
                      Not counted
                    </label>
                  </div>
                  
                  {site.roostType && (
                    <p style={{ color: '#666', fontSize: '14px', margin: '-8px 0 16px 0' }}>
                      {site.roostType} {site.roostLocation && `‚Ä¢ ${site.roostLocation}`}
                    </p>
                  )}

                  {!isSkipped && (
                    <>
                      <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px', marginBottom: '20px' }}>
                        <div style={styles.formGroup}>
                          <label style={styles.label}>Counter 1 (Primary) *</label>
                          <input 
                            type="number" 
                            value={siteData.counter1Total || ''} 
                            onChange={(e) => updateSiteCount(site.id, 'counter1Total', e.target.value)} 
                            style={styles.input} 
                            placeholder="0" 
                            min="0" 
                          />
                        </div>
                        <div style={styles.formGroup}>
                          <label style={styles.label}>Counter 2 (Validation)</label>
                          <input 
                            type="number" 
                            value={siteData.counter2Total || ''} 
                            onChange={(e) => updateSiteCount(site.id, 'counter2Total', e.target.value)} 
                            style={styles.input} 
                            placeholder="0" 
                            min="0" 
                          />
                        </div>
                      </div>

                      <div style={styles.formGroup}>
                        <label style={styles.label}>Pups Seen or Heard?</label>
                        <div style={styles.radioGroup}>
                          <label style={styles.radioLabel}>
                            <input 
                              type="radio" 
                              name={`pups-${site.id}`} 
                              checked={siteData.pupsSeenHeard === 'Yes'} 
                              onChange={() => updateSiteCount(site.id, 'pupsSeenHeard', 'Yes')} 
                              style={styles.radioInput} 
                            />
                            Yes
                          </label>
                          <label style={styles.radioLabel}>
                            <input 
                              type="radio" 
                              name={`pups-${site.id}`} 
                              checked={siteData.pupsSeenHeard === 'No'} 
                              onChange={() => updateSiteCount(site.id, 'pupsSeenHeard', 'No')} 
                              style={styles.radioInput} 
                            />
                            No
                          </label>
                          <label style={styles.radioLabel}>
                            <input 
                              type="radio" 
                              name={`pups-${site.id}`} 
                              checked={siteData.pupsSeenHeard === 'Unknown'} 
                              onChange={() => updateSiteCount(site.id, 'pupsSeenHeard', 'Unknown')} 
                              style={styles.radioInput} 
                            />
                            Unknown
                          </label>
                        </div>
                      </div>

                      <div style={styles.formGroup}>
                        <label style={styles.label}>Site Comment (optional)</label>
                        <input 
                          type="text" 
                          value={siteData.siteComment || ''} 
                          onChange={(e) => updateSiteCount(site.id, 'siteComment', e.target.value)} 
                          style={styles.input} 
                          placeholder="Any notes specific to this roost site" 
                        />
                      </div>
                    </>
                  )}
                </div>
              );
            })}

            <div style={styles.buttonRow}>
              <button type="submit" style={{ ...styles.button, ...styles.buttonPrimary }}>üíæ Save Changes</button>
              <button type="button" onClick={() => { setEditingCount(null); setView('history'); }} style={{ ...styles.button, ...styles.buttonSecondary }}>Cancel</button>
              <button type="button" onClick={handleDeleteAll} style={{ ...styles.button, ...styles.buttonDanger }}>üóëÔ∏è Delete Counting Session</button>
            </div>
          </form>
        );
      };

      // ============ IMPACT REPORT VIEW ============
      const ImpactReportView = () => {
        const currentYear = new Date().getFullYear();
        const availableYears = getAvailableYears();
        const [selectedYear, setSelectedYear] = useState('all');
        
        // Filter counts based on selection
        const filteredCounts = selectedYear === 'all' 
          ? counts 
          : counts.filter(c => new Date(c.date).getFullYear() === parseInt(selectedYear));
        
        // Calculate stats
        const uniqueYears = [...new Set(counts.map(c => new Date(c.date).getFullYear()))].sort();
        const yearsActiveRange = uniqueYears.length > 0 
          ? (uniqueYears.length === 1 
            ? `${uniqueYears[0]}` 
            : `${Math.min(...uniqueYears)} - ${Math.max(...uniqueYears)}`)
          : '‚Äî';
        
        // Effort stats
        const totalSessions = filteredCounts.length;
        const uniqueDates = [...new Set(filteredCounts.map(c => c.date))].length;
        
        const totalVolunteerHours = filteredCounts.reduce((sum, c) => {
          if (!c.startTime || !c.endTime) return sum;
          const [startH, startM] = c.startTime.split(':').map(Number);
          const [endH, endM] = c.endTime.split(':').map(Number);
          const durationHours = (endH + endM/60) - (startH + startM/60);
          const volunteers = parseInt(c.volunteerCount) || 1;
          return sum + (durationHours > 0 ? durationHours * volunteers : 0);
        }, 0);
        
        const totalKm = filteredCounts.reduce((sum, c) => {
          const site = sites.find(s => s.id === c.siteId);
          const property = site ? properties.find(p => p.id === site.propertyId) : null;
          const distanceKm = property?.distanceKm ? parseFloat(property.distanceKm) * 2 : 0;
          return sum + distanceKm;
        }, 0);
        
        // Results stats
        const totalBats = filteredCounts.reduce((sum, c) => sum + (parseInt(c.counter1Total) || 0), 0);
        const avgBatsPerSession = totalSessions > 0 ? (totalBats / totalSessions).toFixed(1) : 0;
        
        const sessionsWithPups = filteredCounts.filter(c => c.pupsSeenHeard === 'Yes' || c.pupsSeenHeard === 'Heard' || c.pupsSeenHeard === 'Seen').length;
        
        // Records
        const highestSingleCount = filteredCounts.length > 0 
          ? Math.max(...filteredCounts.map(c => parseInt(c.counter1Total) || 0))
          : 0;
        
        const highestCountRecord = filteredCounts.find(c => (parseInt(c.counter1Total) || 0) === highestSingleCount);
        const highestCountSite = highestCountRecord ? sites.find(s => s.id === highestCountRecord.siteId) : null;
        const highestCountProperty = highestCountSite ? properties.find(p => p.id === highestCountSite.propertyId) : null;
        
        // Properties and sites stats
        const activePropertyIds = [...new Set(filteredCounts.map(c => {
          const site = sites.find(s => s.id === c.siteId);
          return site?.propertyId;
        }).filter(Boolean))];
        
        const activeSiteIds = [...new Set(filteredCounts.map(c => c.siteId))];
        
        // Sites with bats (non-zero counts)
        const sitesWithBats = [...new Set(filteredCounts.filter(c => (parseInt(c.counter1Total) || 0) > 0).map(c => c.siteId))].length;
        
        const StatCard = ({ value, label, subtext }) => (
          <div style={{ ...styles.summaryCard, minWidth: '140px' }}>
            <div style={styles.summaryNumber}>{value}</div>
            <div style={styles.summaryLabel}>{label}</div>
            {subtext && <div style={{ fontSize: '12px', color: colors.textLight, marginTop: '4px' }}>{subtext}</div>}
          </div>
        );

        return (
          <div>
            <h1 style={{ fontSize: '28px', fontWeight: '600', color: colors.forest, marginBottom: '24px', textAlign: 'center' }}>
              üìä Impact Report
            </h1>
            
            <div style={{ display: 'flex', justifyContent: 'center', marginBottom: '24px' }}>
              <div>
                <label style={{ ...styles.label, fontSize: '16px' }}>Time Period</label>
                <select 
                  value={selectedYear} 
                  onChange={(e) => setSelectedYear(e.target.value)} 
                  style={{ ...styles.select, width: 'auto', minWidth: '150px' }}
                >
                  <option value="all">All Time</option>
                  {availableYears.map(y => <option key={y} value={y}>{y}</option>)}
                </select>
              </div>
            </div>

            {selectedYear === 'all' && (
              <div style={styles.card}>
                <h2 style={styles.cardTitle}>üóìÔ∏è Participation</h2>
                <div style={styles.summaryGrid}>
                  <StatCard value={uniqueYears.length} label="BC Annual Bat Counts" />
                  <StatCard value={yearsActiveRange} label="Years Active" />
                </div>
              </div>
            )}

            <div style={styles.card}>
              <h2 style={styles.cardTitle}>üí™ Effort</h2>
              <div style={styles.summaryGrid}>
                <StatCard value={totalSessions} label="Counting Sessions" />
                <StatCard value={uniqueDates} label="Evenings Out" />
                <StatCard value={totalVolunteerHours > 0 ? Math.round(totalVolunteerHours) : '‚Äî'} label="Volunteer Hours" />
                <StatCard value={totalKm > 0 ? Math.round(totalKm).toLocaleString() : '‚Äî'} label="Km Traveled" />
              </div>
            </div>

            <div style={styles.card}>
              <h2 style={styles.cardTitle}>ü¶á Results</h2>
              <div style={styles.summaryGrid}>
                <StatCard value={totalBats.toLocaleString()} label="Bats Counted" />
                <StatCard value={avgBatsPerSession} label="Avg per Session" />
                <StatCard value={sessionsWithPups} label="Pup Sightings" />
                <StatCard value={sitesWithBats} label="Active Roosts" subtext={`of ${activeSiteIds.length} sites visited`} />
              </div>
            </div>

            <div style={styles.card}>
              <h2 style={styles.cardTitle}>üèÜ Records</h2>
              <div style={styles.summaryGrid}>
                <StatCard 
                  value={highestSingleCount} 
                  label="Highest Single Count" 
                  subtext={highestCountProperty ? `${highestCountProperty.name}` : ''} 
                />
                <StatCard value={activePropertyIds.length} label="Properties Counted" />
                <StatCard value={activeSiteIds.length} label="Sites Counted" />
              </div>
            </div>
          </div>
        );
      };

      // ============ SEASON VIEW ============
      const SeasonView = () => {
        const currentYear = new Date().getFullYear();
        const availableYears = getAvailableYears();
        const [selectedPropertyId, setSelectedPropertyId] = useState('');
        const [selectedYear, setSelectedYear] = useState(currentYear);
        const [compareYear, setCompareYear] = useState(availableYears.find(y => y < currentYear) || null);

        const seasonData = selectedPropertyId ? getSeasonData(selectedPropertyId, selectedYear) : [];
        const compareData = selectedPropertyId && compareYear ? getSeasonData(selectedPropertyId, compareYear) : [];

        const selectedProperty = properties.find(p => p.id === selectedPropertyId);

        // Season Progress calculation
        const thisYearCounts = counts.filter(c => new Date(c.date).getFullYear() === currentYear);
        const today = new Date();
        const countPeriods = [
          { num: 1, label: 'Count #1', dateRange: 'Jun 1-21', slot: 'june' },
          { num: 2, label: 'Count #2', dateRange: 'Jun 1-21', slot: 'june' },
          { num: 3, label: 'Count #3', dateRange: 'Jul 11 - Aug 5', slot: 'julyAug' },
          { num: 4, label: 'Count #4', dateRange: 'Jul 11 - Aug 5', slot: 'julyAug' },
        ];
        
        const getPropertySessionCounts = (slot) => {
          const slotCounts = thisYearCounts.filter(c => getSeasonSlot(c.date) === slot);
          const propertySessionCounts = {};
          
          properties.forEach(p => {
            const propertySites = sites.filter(s => s.propertyId === p.id);
            const siteIds = propertySites.map(s => s.id);
            const propertySlotCounts = slotCounts.filter(c => siteIds.includes(c.siteId));
            const uniqueDates = [...new Set(propertySlotCounts.map(c => c.date))];
            propertySessionCounts[p.id] = uniqueDates.length;
          });
          
          return propertySessionCounts;
        };
        
        const juneByProperty = getPropertySessionCounts('june');
        const julyAugByProperty = getPropertySessionCounts('julyAug');
        
        const totalProperties = properties.length;
        
        const getCompletedCountsForSlot = (byProperty) => {
          if (totalProperties === 0) return 0;
          const sessionCounts = Object.values(byProperty);
          return sessionCounts.length > 0 ? Math.min(...sessionCounts) : 0;
        };
        
        const juneCompleteCounts = getCompletedCountsForSlot(juneByProperty);
        const julyAugCompleteCounts = getCompletedCountsForSlot(julyAugByProperty);
        
        // Calculate percentage of properties complete for each count period
        const getCountProgress = (periodNum) => {
          if (totalProperties === 0) return 0;
          
          // For count 1: how many properties have at least 1 june count
          // For count 2: how many properties have at least 2 june counts
          // For count 3: how many properties have at least 1 julyAug count
          // For count 4: how many properties have at least 2 julyAug counts
          
          const byProperty = periodNum <= 2 ? juneByProperty : julyAugByProperty;
          const requiredCount = periodNum <= 2 ? periodNum : periodNum - 2;
          
          const propertiesComplete = Object.values(byProperty).filter(count => count >= requiredCount).length;
          return propertiesComplete / totalProperties;
        };
        
        // Interpolate between colors based on percentage (0-1)
        // Goes from sand (0%) ‚Üí teal shades ‚Üí forest green (100%)
        const getProgressColor = (percent) => {
          // Color stops: sand ‚Üí light teal ‚Üí medium teal ‚Üí dark teal ‚Üí forest green
          const stops = [
            { pos: 0, r: 232, g: 228, b: 220 },    // sand (#e8e4dc) - not started
            { pos: 0.01, r: 143, g: 186, b: 190 }, // light teal (#8FBABE) - just started
            { pos: 0.5, r: 25, g: 94, b: 94 },     // medium teal (#195E5E)
            { pos: 0.99, r: 8, g: 60, b: 60 },     // dark teal (#083C3C)
            { pos: 1, r: 26, g: 60, b: 52 },       // forest green (#1a3c34) - complete
          ];
          
          // Find which two stops we're between
          let lower = stops[0];
          let upper = stops[stops.length - 1];
          for (let i = 0; i < stops.length - 1; i++) {
            if (percent >= stops[i].pos && percent <= stops[i + 1].pos) {
              lower = stops[i];
              upper = stops[i + 1];
              break;
            }
          }
          
          // Interpolate
          const range = upper.pos - lower.pos;
          const factor = range > 0 ? (percent - lower.pos) / range : 0;
          
          const r = Math.round(lower.r + (upper.r - lower.r) * factor);
          const g = Math.round(lower.g + (upper.g - lower.g) * factor);
          const b = Math.round(lower.b + (upper.b - lower.b) * factor);
          
          // Determine text color (dark for light backgrounds, white for dark)
          const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
          const textColor = luminance > 0.5 ? '#2d2a26' : '#ffffff';
          
          return { bg: `rgb(${r}, ${g}, ${b})`, text: textColor };
        };
        
        const getSlotStatus = (periodNum) => {
          if (periodNum <= 2) {
            return juneCompleteCounts >= periodNum ? 'complete' : 'upcoming';
          } else {
            return julyAugCompleteCounts >= (periodNum - 2) ? 'complete' : 'upcoming';
          }
        };
        
        const getCurrentPeriod = () => {
          const month = today.getMonth();
          const day = today.getDate();
          if (month < 5) return 0;
          if (month === 5 && day <= 21) return juneCompleteCounts < 2 ? (juneCompleteCounts + 1) : 2;
          if (month === 5 && day > 21 && month < 6) return 2;
          if ((month === 6 && day >= 11) || (month === 7 && day <= 5)) return julyAugCompleteCounts < 2 ? (julyAugCompleteCounts + 3) : 4;
          return 5;
        };
        
        const currentPeriod = getCurrentPeriod();

        // Calculate totals - but for comparison, only compare slots that have data in BOTH years
        const currentTotal = seasonData.reduce((sum, d) => sum + d.totalBats, 0);
        const compareTotal = compareData.reduce((sum, d) => sum + d.totalBats, 0);

        // For apples-to-apples comparison: which slots have data in current year (any site)?
        const currentHasJune1 = seasonData.some(d => d.june1);
        const currentHasJune2 = seasonData.some(d => d.june2);
        const currentHasJulyAug1 = seasonData.some(d => d.julyAug1);
        const currentHasJulyAug2 = seasonData.some(d => d.julyAug2);

        // Sum ALL sites for a slot (if that slot has any data in current year, the count "happened")
        const getSlotTotal = (data, slot) => data.reduce((sum, d) => sum + (getCountTotal(d[slot]) || 0), 0);
        
        const currentMatchingTotal = 
          (currentHasJune1 ? getSlotTotal(seasonData, 'june1') : 0) +
          (currentHasJune2 ? getSlotTotal(seasonData, 'june2') : 0) +
          (currentHasJulyAug1 ? getSlotTotal(seasonData, 'julyAug1') : 0) +
          (currentHasJulyAug2 ? getSlotTotal(seasonData, 'julyAug2') : 0);

        const compareMatchingTotal = 
          (currentHasJune1 ? getSlotTotal(compareData, 'june1') : 0) +
          (currentHasJune2 ? getSlotTotal(compareData, 'june2') : 0) +
          (currentHasJulyAug1 ? getSlotTotal(compareData, 'julyAug1') : 0) +
          (currentHasJulyAug2 ? getSlotTotal(compareData, 'julyAug2') : 0);

        // Count how many slots are being compared
        const slotsCompared = [currentHasJune1, currentHasJune2, currentHasJulyAug1, currentHasJulyAug2].filter(Boolean).length;

        // Comparison indicator component
        const CompareIndicator = ({ current, previous }) => {
          if (current === null || previous === null) return null;
          const diff = current - previous;
          if (diff > 0) return <span style={{ color: '#2e7d32', marginLeft: '4px', fontSize: '14px' }}>‚Üë</span>;
          if (diff < 0) return <span style={{ color: '#dc3545', marginLeft: '4px', fontSize: '14px' }}>‚Üì</span>;
          return <span style={{ color: '#888', marginLeft: '4px', fontSize: '14px' }}>‚Üí</span>;
        };

        // Get comparison value for a slot
        const getCompareValue = (siteId, slot) => {
          const siteCompare = compareData.find(d => d.site.id === siteId);
          if (!siteCompare) return null;
          const count = siteCompare[slot];
          return count ? getCountTotal(count) : null;
        };

        // Cell component for count display
        const CountCell = ({ count, siteId, slot, isUpcoming }) => {
          const total = getCountTotal(count);
          const compareValue = compareYear ? getCompareValue(siteId, slot) : null;
          
          if (count) {
            return (
              <td style={{ ...styles.td, textAlign: 'center', backgroundColor: '#f0fff0' }}>
                <div style={{ fontSize: '20px', fontWeight: 'bold' }}>
                  {total}
                  <CompareIndicator current={total} previous={compareValue} />
                </div>
                <div style={{ fontSize: '12px', color: '#666' }}>{formatDate(count.date).split(',')[0]}</div>
              </td>
            );
          }
          
          if (isUpcoming) {
            return (
              <td style={{ ...styles.td, textAlign: 'center', backgroundColor: '#fff9e6' }}>
                <div style={{ fontSize: '14px', color: '#997a00', fontStyle: 'italic' }}>upcoming</div>
              </td>
            );
          }
          
          return (
            <td style={{ ...styles.td, textAlign: 'center', backgroundColor: '#f8f8f8' }}>
              <div style={{ fontSize: '14px', color: '#999' }}>‚Äî</div>
            </td>
          );
        };

        // Determine if a slot is upcoming (only for current year)
        const isSlotUpcoming = (slot) => {
          if (selectedYear !== currentYear) return false;
          const now = new Date();
          const month = now.getMonth();
          const day = now.getDate();
          
          if (slot === 'june1' || slot === 'june2') {
            return month < 5 || (month === 5 && day <= 21);
          }
          if (slot === 'julyAug1' || slot === 'julyAug2') {
            return month < 6 || (month === 6 && day < 11);
          }
          return false;
        };

        // Years for dropdown (include current year even if no data)
        const yearOptions = [...new Set([currentYear, ...availableYears])].sort((a, b) => b - a);
        const compareYearOptions = availableYears.filter(y => y !== selectedYear);

        return (
          <div>
            <h1 style={{ fontSize: '28px', fontWeight: '600', color: colors.forest, marginBottom: '24px', textAlign: 'center' }}>
              ‚òÄÔ∏è Season Overview
            </h1>

            {/* Season Progress Indicator */}
            {properties.length > 0 && (
              <div style={styles.progressContainer}>
                <div style={styles.progressTitle}>
                  <span>ü¶á</span> {currentYear} Season Progress
                </div>
                <div style={styles.progressTrack}>
                  {countPeriods.map((period, idx) => {
                    const progress = getCountProgress(period.num);
                    const progressColor = getProgressColor(progress);
                    const isCurrent = period.num === currentPeriod;
                    const isComplete = progress === 1;
                    
                    let dotStyle = {
                      backgroundColor: progressColor.bg,
                      color: progressColor.text
                    };
                    
                    // Add ring highlight for current period if not complete
                    if (isCurrent && !isComplete) {
                      const targetColor = getProgressColor(1); // green
                      dotStyle.boxShadow = `0 0 0 3px ${colors.cream}, 0 0 0 5px ${targetColor.bg}`;
                    }
                    
                    return (
                      <div key={idx} style={styles.progressSlot}>
                        <div style={{ ...styles.progressDot, ...dotStyle }}>
                          {isComplete ? '‚úì' : period.num}
                        </div>
                        <div style={styles.progressLabel}>{period.label}</div>
                        <div style={styles.progressDate}>{period.dateRange}</div>
                        {progress > 0 && progress < 1 && (
                          <div style={{ fontSize: '11px', color: colors.textLight, marginTop: '2px' }}>
                            {Math.round(progress * 100)}%
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              </div>
            )}

            {/* Season Calendar View */}
            <div style={styles.card}>
              <h2 style={styles.cardTitle}>üìÖ {currentYear} Count Calendar</h2>
              
              {(() => {
                // Get all count dates for current year with property info
                const countsByDate = {};
                thisYearCounts.forEach(c => {
                  const site = sites.find(s => s.id === c.siteId);
                  const property = site ? properties.find(p => p.id === site.propertyId) : null;
                  const propertyName = property ? property.name : 'Unknown';
                  
                  if (!countsByDate[c.date]) {
                    countsByDate[c.date] = [];
                  }
                  countsByDate[c.date].push(propertyName);
                });
                
                // Helper to check if date is in count window
                const isInCountWindow = (month, day) => {
                  // June 1-21
                  if (month === 5 && day >= 1 && day <= 21) return 'june';
                  // July 11-31
                  if (month === 6 && day >= 11) return 'julyAug';
                  // Aug 1-5
                  if (month === 7 && day >= 1 && day <= 5) return 'julyAug';
                  return null;
                };
                
                // Generate calendar for a month
                const renderMonth = (monthIndex, monthName) => {
                  const firstDay = new Date(currentYear, monthIndex, 1).getDay();
                  const daysInMonth = new Date(currentYear, monthIndex + 1, 0).getDate();
                  const weeks = [];
                  let currentWeek = new Array(firstDay).fill(null);
                  
                  for (let day = 1; day <= daysInMonth; day++) {
                    currentWeek.push(day);
                    if (currentWeek.length === 7) {
                      weeks.push(currentWeek);
                      currentWeek = [];
                    }
                  }
                  if (currentWeek.length > 0) {
                    while (currentWeek.length < 7) currentWeek.push(null);
                    weeks.push(currentWeek);
                  }
                  
                  return (
                    <div style={{ flex: '1', minWidth: '200px' }}>
                      <div style={{ textAlign: 'center', fontWeight: '600', color: colors.forest, marginBottom: '8px', fontSize: '16px' }}>
                        {monthName}
                      </div>
                      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: '2px', fontSize: '12px' }}>
                        {['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'].map(d => (
                          <div key={d} style={{ textAlign: 'center', color: colors.textLight, fontWeight: '500', padding: '4px 0' }}>{d}</div>
                        ))}
                        {weeks.flat().map((day, idx) => {
                          if (day === null) {
                            return <div key={idx} style={{ padding: '6px 0' }}></div>;
                          }
                          
                          const dateStr = `${currentYear}-${String(monthIndex + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                          const dateProperties = countsByDate[dateStr] || [];
                          const hasCount = dateProperties.length > 0;
                          const countWindow = isInCountWindow(monthIndex, day);
                          
                          // Create tooltip text with unique property names
                          const uniqueProperties = [...new Set(dateProperties)];
                          const tooltipText = hasCount ? uniqueProperties.join(', ') : '';
                          
                          let bgColor = 'transparent';
                          let textColor = colors.text;
                          
                          if (countWindow === 'june') {
                            bgColor = 'rgba(143, 186, 190, 0.3)';  // Light teal for June
                          } else if (countWindow === 'julyAug') {
                            bgColor = 'rgba(74, 124, 89, 0.2)';    // Light green for July/Aug
                          }
                          
                          if (hasCount) {
                            bgColor = colors.forest;
                            textColor = '#ffffff';
                          }
                          
                          return (
                            <div 
                              key={idx} 
                              title={tooltipText}
                              style={{ 
                                textAlign: 'center', 
                                padding: '6px 0',
                                backgroundColor: bgColor,
                                color: textColor,
                                borderRadius: hasCount ? '50%' : '2px',
                                fontWeight: hasCount ? '600' : '400',
                                cursor: hasCount ? 'pointer' : 'default',
                              }}
                            >
                              {day}
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  );
                };
                
                return (
                  <div>
                    <div style={{ display: 'flex', gap: '24px', flexWrap: 'wrap', justifyContent: 'center' }}>
                      {renderMonth(5, 'June')}
                      {renderMonth(6, 'July')}
                      {renderMonth(7, 'August')}
                    </div>
                    <div style={{ display: 'flex', justifyContent: 'center', gap: '20px', marginTop: '16px', fontSize: '13px', color: colors.textLight, flexWrap: 'wrap' }}>
                      <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                        <div style={{ width: '16px', height: '16px', backgroundColor: 'rgba(143, 186, 190, 0.3)', borderRadius: '2px' }}></div>
                        <span>Jun 1-21</span>
                      </div>
                      <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                        <div style={{ width: '16px', height: '16px', backgroundColor: 'rgba(74, 124, 89, 0.2)', borderRadius: '2px' }}></div>
                        <span>Jul 11 - Aug 5</span>
                      </div>
                      <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                        <div style={{ width: '16px', height: '16px', backgroundColor: colors.forest, borderRadius: '50%' }}></div>
                        <span>Count completed</span>
                      </div>
                    </div>
                  </div>
                );
              })()}
            </div>

            <div style={styles.card}>
              <h2 style={styles.cardTitle}>üìä Season to Season Comparison</h2>

              <div style={{ display: 'flex', gap: '20px', marginBottom: '24px', flexWrap: 'wrap', alignItems: 'flex-end' }}>
                <div>
                  <label style={{ ...styles.label, fontSize: '16px' }}>Property</label>
                  <select 
                    value={selectedPropertyId} 
                    onChange={(e) => setSelectedPropertyId(e.target.value)} 
                    style={{ ...styles.select, width: 'auto', minWidth: '200px' }}
                  >
                    <option value="">-- Select property --</option>
                    {properties.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                  </select>
                </div>
                <div>
                  <label style={{ ...styles.label, fontSize: '16px' }}>Year</label>
                  <select 
                    value={selectedYear} 
                    onChange={(e) => setSelectedYear(parseInt(e.target.value))} 
                    style={{ ...styles.select, width: 'auto', minWidth: '120px' }}
                  >
                    {yearOptions.map(y => <option key={y} value={y}>{y}</option>)}
                  </select>
                </div>
                <div>
                  <label style={{ ...styles.label, fontSize: '16px' }}>Compare to</label>
                  <select 
                    value={compareYear || ''} 
                    onChange={(e) => setCompareYear(e.target.value ? parseInt(e.target.value) : null)} 
                    style={{ ...styles.select, width: 'auto', minWidth: '120px' }}
                  >
                    <option value="">None</option>
                    {compareYearOptions.map(y => <option key={y} value={y}>{y}</option>)}
                  </select>
                </div>
              </div>

              {!selectedPropertyId ? (
                <div style={styles.emptyState}>
                  <p>Select a property to view the season overview.</p>
                </div>
              ) : seasonData.length === 0 ? (
                <div style={styles.emptyState}>
                  <p>No roost sites for this property yet.</p>
                </div>
              ) : (
                <>
                  {/* Current Year Table */}
                  <h3 style={{ fontSize: '20px', color: '#2c5530', marginBottom: '16px' }}>
                    {selectedYear} Season ‚Äì {selectedProperty?.name}
                  </h3>
                  
                  <div style={{ overflowX: 'auto', marginBottom: '24px' }}>
                    <table style={{ ...styles.table, minWidth: '700px' }}>
                      <thead>
                        <tr>
                          <th style={{ ...styles.th, width: '25%' }}>Roost Site</th>
                          <th style={{ ...styles.th, textAlign: 'center', width: '15%' }}>Count #1</th>
                          <th style={{ ...styles.th, textAlign: 'center', width: '15%' }}>Count #2</th>
                          <th style={{ ...styles.th, textAlign: 'center', width: '15%' }}>Count #3</th>
                          <th style={{ ...styles.th, textAlign: 'center', width: '15%' }}>Count #4</th>
                          <th style={{ ...styles.th, textAlign: 'center', width: '15%' }} title="Arrows compare only count periods completed this year">Total {compareYear && <span style={{ fontSize: '12px', fontWeight: 'normal' }}>‚Üë‚Üì</span>}</th>
                        </tr>
                        <tr style={{ backgroundColor: '#f0f0f0' }}>
                          <td style={{ padding: '8px 12px', fontSize: '12px', color: '#666' }}></td>
                          <td style={{ padding: '8px 12px', fontSize: '12px', color: '#666', textAlign: 'center' }}>Jun 1-21</td>
                          <td style={{ padding: '8px 12px', fontSize: '12px', color: '#666', textAlign: 'center' }}>Jun 1-21</td>
                          <td style={{ padding: '8px 12px', fontSize: '12px', color: '#666', textAlign: 'center' }}>Jul 11-Aug 5</td>
                          <td style={{ padding: '8px 12px', fontSize: '12px', color: '#666', textAlign: 'center' }}>Jul 11-Aug 5</td>
                          <td style={{ padding: '8px 12px', fontSize: '12px', color: '#666', textAlign: 'center' }}>{compareYear && 'vs ' + compareYear}</td>
                        </tr>
                      </thead>
                      <tbody>
                        {seasonData.map(({ site, june1, june2, julyAug1, julyAug2, totalBats }) => {
                          const compareRow = compareData.find(d => d.site.id === site.id);
                          
                          // Calculate matching slot totals for this site based on property-level slot availability
                          const currentSiteMatching = 
                            (currentHasJune1 ? (getCountTotal(june1) || 0) : 0) +
                            (currentHasJune2 ? (getCountTotal(june2) || 0) : 0) +
                            (currentHasJulyAug1 ? (getCountTotal(julyAug1) || 0) : 0) +
                            (currentHasJulyAug2 ? (getCountTotal(julyAug2) || 0) : 0);
                          
                          const compareSiteMatching = compareRow ? (
                            (currentHasJune1 ? (getCountTotal(compareRow.june1) || 0) : 0) +
                            (currentHasJune2 ? (getCountTotal(compareRow.june2) || 0) : 0) +
                            (currentHasJulyAug1 ? (getCountTotal(compareRow.julyAug1) || 0) : 0) +
                            (currentHasJulyAug2 ? (getCountTotal(compareRow.julyAug2) || 0) : 0)
                          ) : null;
                          
                          return (
                            <tr key={site.id}>
                              <td style={{ ...styles.td, fontWeight: '600' }}>{site.name}</td>
                              <CountCell count={june1} siteId={site.id} slot="june1" isUpcoming={isSlotUpcoming('june1') && !june1} />
                              <CountCell count={june2} siteId={site.id} slot="june2" isUpcoming={isSlotUpcoming('june2') && !june2 && june1} />
                              <CountCell count={julyAug1} siteId={site.id} slot="julyAug1" isUpcoming={isSlotUpcoming('julyAug1') && !julyAug1} />
                              <CountCell count={julyAug2} siteId={site.id} slot="julyAug2" isUpcoming={isSlotUpcoming('julyAug2') && !julyAug2 && julyAug1} />
                              <td style={{ ...styles.td, textAlign: 'center', fontWeight: 'bold', fontSize: '20px' }}>
                                {totalBats}
                                {compareSiteMatching !== null && (currentSiteMatching > 0 || compareSiteMatching > 0) && <CompareIndicator current={currentSiteMatching} previous={compareSiteMatching} />}
                              </td>
                            </tr>
                          );
                        })}
                        {/* Totals row */}
                        <tr style={{ backgroundColor: '#e8f5e9' }}>
                          <td style={{ ...styles.td, fontWeight: 'bold', fontSize: '18px' }}>Property Total</td>
                          <td style={{ ...styles.td, textAlign: 'center', fontWeight: 'bold' }}>
                            {seasonData.reduce((sum, d) => sum + (getCountTotal(d.june1) || 0), 0) || '‚Äî'}
                          </td>
                          <td style={{ ...styles.td, textAlign: 'center', fontWeight: 'bold' }}>
                            {seasonData.reduce((sum, d) => sum + (getCountTotal(d.june2) || 0), 0) || '‚Äî'}
                          </td>
                          <td style={{ ...styles.td, textAlign: 'center', fontWeight: 'bold' }}>
                            {seasonData.reduce((sum, d) => sum + (getCountTotal(d.julyAug1) || 0), 0) || '‚Äî'}
                          </td>
                          <td style={{ ...styles.td, textAlign: 'center', fontWeight: 'bold' }}>
                            {seasonData.reduce((sum, d) => sum + (getCountTotal(d.julyAug2) || 0), 0) || '‚Äî'}
                          </td>
                          <td style={{ ...styles.td, textAlign: 'center', fontWeight: 'bold', fontSize: '22px' }}>
                            {currentTotal}
                            {compareMatchingTotal > 0 && <CompareIndicator current={currentMatchingTotal} previous={compareMatchingTotal} />}
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>

                  {/* Comparison Year Table */}
                  {compareYear && compareData.length > 0 && (
                    <>
                      <h3 style={{ fontSize: '20px', color: '#666', marginBottom: '16px', marginTop: '32px' }}>
                        üìä {compareYear} Comparison
                      </h3>
                      
                      <div style={{ overflowX: 'auto' }}>
                        <table style={{ ...styles.table, minWidth: '700px', opacity: 0.85 }}>
                          <thead>
                            <tr>
                              <th style={{ ...styles.th, width: '25%', backgroundColor: '#666' }}>Roost Site</th>
                              <th style={{ ...styles.th, textAlign: 'center', width: '15%', backgroundColor: '#666' }}>Count #1</th>
                              <th style={{ ...styles.th, textAlign: 'center', width: '15%', backgroundColor: '#666' }}>Count #2</th>
                              <th style={{ ...styles.th, textAlign: 'center', width: '15%', backgroundColor: '#666' }}>Count #3</th>
                              <th style={{ ...styles.th, textAlign: 'center', width: '15%', backgroundColor: '#666' }}>Count #4</th>
                              <th style={{ ...styles.th, textAlign: 'center', width: '15%', backgroundColor: '#666' }}>Total</th>
                            </tr>
                            <tr style={{ backgroundColor: '#f0f0f0' }}>
                              <td style={{ padding: '8px 12px', fontSize: '12px', color: '#666' }}></td>
                              <td style={{ padding: '8px 12px', fontSize: '12px', color: '#666', textAlign: 'center' }}>Jun 1-21</td>
                              <td style={{ padding: '8px 12px', fontSize: '12px', color: '#666', textAlign: 'center' }}>Jun 1-21</td>
                              <td style={{ padding: '8px 12px', fontSize: '12px', color: '#666', textAlign: 'center' }}>Jul 11-Aug 5</td>
                              <td style={{ padding: '8px 12px', fontSize: '12px', color: '#666', textAlign: 'center' }}>Jul 11-Aug 5</td>
                              <td style={{ padding: '8px 12px', fontSize: '12px', color: '#666', textAlign: 'center' }}></td>
                            </tr>
                          </thead>
                          <tbody>
                            {compareData.map(({ site, june1, june2, julyAug1, julyAug2, totalBats }) => (
                              <tr key={site.id}>
                                <td style={{ ...styles.td, fontWeight: '600' }}>{site.name}</td>
                                <td style={{ ...styles.td, textAlign: 'center' }}>
                                  {june1 ? (
                                    <>
                                      <div>{getCountTotal(june1)}</div>
                                      <div style={{ fontSize: '12px', color: '#666' }}>{formatDate(june1.date).split(',')[0]}</div>
                                    </>
                                  ) : '‚Äî'}
                                </td>
                                <td style={{ ...styles.td, textAlign: 'center' }}>
                                  {june2 ? (
                                    <>
                                      <div>{getCountTotal(june2)}</div>
                                      <div style={{ fontSize: '12px', color: '#666' }}>{formatDate(june2.date).split(',')[0]}</div>
                                    </>
                                  ) : '‚Äî'}
                                </td>
                                <td style={{ ...styles.td, textAlign: 'center' }}>
                                  {julyAug1 ? (
                                    <>
                                      <div>{getCountTotal(julyAug1)}</div>
                                      <div style={{ fontSize: '12px', color: '#666' }}>{formatDate(julyAug1.date).split(',')[0]}</div>
                                    </>
                                  ) : '‚Äî'}
                                </td>
                                <td style={{ ...styles.td, textAlign: 'center' }}>
                                  {julyAug2 ? (
                                    <>
                                      <div>{getCountTotal(julyAug2)}</div>
                                      <div style={{ fontSize: '12px', color: '#666' }}>{formatDate(julyAug2.date).split(',')[0]}</div>
                                    </>
                                  ) : '‚Äî'}
                                </td>
                                <td style={{ ...styles.td, textAlign: 'center', fontWeight: 'bold' }}>{totalBats}</td>
                              </tr>
                            ))}
                            <tr style={{ backgroundColor: '#f0f0f0' }}>
                              <td style={{ ...styles.td, fontWeight: 'bold' }}>Property Total</td>
                              <td style={{ ...styles.td, textAlign: 'center', fontWeight: 'bold' }}>
                                {compareData.reduce((sum, d) => sum + (getCountTotal(d.june1) || 0), 0) || '‚Äî'}
                              </td>
                              <td style={{ ...styles.td, textAlign: 'center', fontWeight: 'bold' }}>
                                {compareData.reduce((sum, d) => sum + (getCountTotal(d.june2) || 0), 0) || '‚Äî'}
                              </td>
                              <td style={{ ...styles.td, textAlign: 'center', fontWeight: 'bold' }}>
                                {compareData.reduce((sum, d) => sum + (getCountTotal(d.julyAug1) || 0), 0) || '‚Äî'}
                              </td>
                              <td style={{ ...styles.td, textAlign: 'center', fontWeight: 'bold' }}>
                                {compareData.reduce((sum, d) => sum + (getCountTotal(d.julyAug2) || 0), 0) || '‚Äî'}
                              </td>
                              <td style={{ ...styles.td, textAlign: 'center', fontWeight: 'bold', fontSize: '18px' }}>{compareTotal}</td>
                            </tr>
                          </tbody>
                        </table>
                      </div>

                      {/* Year over year summary - comparing only matching slots */}
                      <div style={{ marginTop: '24px', padding: '20px', backgroundColor: currentMatchingTotal >= compareMatchingTotal ? '#e8f5e9' : '#fff3cd', borderRadius: '8px' }}>
                        <p style={{ fontSize: '18px', margin: 0, textAlign: 'center' }}>
                          <strong>{selectedYear} vs {compareYear}</strong>
                          {slotsCompared < 4 && (
                            <span style={{ fontSize: '14px', color: '#666', fontWeight: 'normal' }}> (comparing {slotsCompared} of 4 count periods)</span>
                          )}
                          <strong>:</strong>{' '}
                          {compareMatchingTotal === 0 ? (
                            <span style={{ color: '#666' }}>No matching data in {compareYear}</span>
                          ) : currentMatchingTotal > compareMatchingTotal ? (
                            <span style={{ color: '#2e7d32' }}>
                              ‚Üë Up {currentMatchingTotal - compareMatchingTotal} bats ({Math.round((currentMatchingTotal - compareMatchingTotal) / compareMatchingTotal * 100)}%)
                            </span>
                          ) : currentMatchingTotal < compareMatchingTotal ? (
                            <span style={{ color: '#856404' }}>
                              ‚Üì Down {compareMatchingTotal - currentMatchingTotal} bats ({Math.round((compareMatchingTotal - currentMatchingTotal) / compareMatchingTotal * 100)}%)
                            </span>
                          ) : (
                            <span style={{ color: '#666' }}>‚Üí Same as {compareYear}</span>
                          )}
                        </p>
                        {slotsCompared < 4 && (
                          <p style={{ fontSize: '13px', color: '#666', margin: '12px 0 0 0', textAlign: 'center', fontStyle: 'italic' }}>
                            ‚ÑπÔ∏è Comparison includes only count periods completed in {selectedYear} ({[
                              currentHasJune1 && 'Count #1',
                              currentHasJune2 && 'Count #2', 
                              currentHasJulyAug1 && 'Count #3',
                              currentHasJulyAug2 && 'Count #4'
                            ].filter(Boolean).join(', ')})
                          </p>
                        )}
                      </div>
                    </>
                  )}
                  
                  <p style={{ ...styles.helpText, marginTop: '16px', textAlign: 'center' }}>
                    Totals use Counter 1. Counter 2 is recorded for BC Bats data validation.
                  </p>
                </>
              )}
            </div>

            <button onClick={() => setView('home')} style={{ ...styles.button, ...styles.buttonSecondary }}>‚Üê Back to Home</button>
          </div>
        );
      };

      // ============ MILEAGE REPORT VIEW ============
      const MileageReportView = () => {
        const currentYear = new Date().getFullYear();
        const availableYears = getAvailableYears();
        const [selectedYear, setSelectedYear] = useState(currentYear);

        // Get all counts for the selected year with mileage info
        const yearCounts = counts
          .filter(c => new Date(c.date).getFullYear() === selectedYear)
          .sort((a, b) => new Date(a.date) - new Date(b.date))
          .map(count => {
            const site = sites.find(s => s.id === count.siteId);
            const property = site ? properties.find(p => p.id === site.propertyId) : null;
            const distanceKm = property?.distanceKm ? parseFloat(property.distanceKm) : 0;
            const roundTripKm = distanceKm * 2;
            
            return {
              ...count,
              site,
              property,
              distanceKm,
              roundTripKm,
            };
          });

        const totalKm = yearCounts.reduce((sum, c) => sum + c.roundTripKm, 0);
        const tripsWithMileage = yearCounts.filter(c => c.roundTripKm > 0).length;
        const tripsWithoutMileage = yearCounts.filter(c => c.roundTripKm === 0).length;

        // Group by property for summary
        const byProperty = {};
        yearCounts.forEach(c => {
          const propName = c.property?.name || 'Unknown Property';
          if (!byProperty[propName]) {
            byProperty[propName] = { trips: 0, totalKm: 0, distanceKm: c.distanceKm };
          }
          byProperty[propName].trips++;
          byProperty[propName].totalKm += c.roundTripKm;
        });

        const yearOptions = [...new Set([currentYear, ...availableYears])].sort((a, b) => b - a);

        // Export mileage to CSV
        const exportMileageCSV = () => {
          const headers = [
            'Date', 'Property', 'Purpose', 'From', 'To', 'Round Trip (km)'
          ];

          // Helper to escape CSV fields (wrap in quotes if contains comma, quote, or newline)
          const escapeCSV = (field) => {
            const str = String(field || '');
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
              return '"' + str.replace(/"/g, '""') + '"';
            }
            return str;
          };

          const rows = yearCounts.map(count => {
            // Build a sensible "To" address
            let toAddress = count.property?.landownerAddress;
            if (!toAddress && count.property?.name) {
              toAddress = count.property.name + ', Thetis Island, BC';
            }
            if (!toAddress) {
              toAddress = 'Unknown property';
            }
            
            return [
              count.date || '',
              escapeCSV(count.property?.name || 'Unknown'),
              'BC Annual Bat Count',
              escapeCSV('83 Blue Heron Rd, Thetis Island, BC'),
              escapeCSV(toAddress),
              count.roundTripKm > 0 ? count.roundTripKm.toFixed(1) : '',
            ];
          });

          // Add total row
          rows.push(['', '', '', '', 'TOTAL:', totalKm.toFixed(1)]);

          const csvContent = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
          const blob = new Blob([csvContent], { type: 'text/csv' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'Thetis-Island-Bat-Count-Mileage-' + selectedYear + '.csv';
          a.click();
          URL.revokeObjectURL(url);
          showMessage('Mileage report exported!');
        };

        return (
          <div>
            <div style={styles.card}>
              <h2 style={styles.cardTitle}>üöó Mileage Report</h2>

              <div style={{ display: 'flex', gap: '20px', marginBottom: '24px', alignItems: 'flex-end', flexWrap: 'wrap' }}>
                <div>
                  <label style={{ ...styles.label, fontSize: '16px' }}>Year</label>
                  <select 
                    value={selectedYear} 
                    onChange={(e) => setSelectedYear(parseInt(e.target.value))} 
                    style={{ ...styles.select, width: 'auto', minWidth: '120px' }}
                  >
                    {yearOptions.map(y => <option key={y} value={y}>{y}</option>)}
                  </select>
                </div>
                <button 
                  onClick={exportMileageCSV} 
                  style={{ ...styles.button, ...styles.buttonPrimary }}
                  disabled={yearCounts.length === 0}
                >
                  üì• Export Mileage CSV
                </button>
              </div>

              {/* Summary Cards */}
              <div style={styles.summaryGrid}>
                <div style={styles.summaryCard}>
                  <div style={styles.summaryNumber}>{yearCounts.length}</div>
                  <div style={styles.summaryLabel}>Total Trips</div>
                </div>
                <div style={styles.summaryCard}>
                  <div style={styles.summaryNumber}>{totalKm.toFixed(1)}</div>
                  <div style={styles.summaryLabel}>Total km</div>
                </div>
                <div style={{ ...styles.summaryCard, backgroundColor: '#e3f2fd' }}>
                  <div style={{ ...styles.summaryNumber, color: '#1565c0' }}>{(totalKm * 0.14).toFixed(2)}</div>
                  <div style={styles.summaryLabel}>Est. Value @ $0.14/km</div>
                </div>
              </div>

              {tripsWithoutMileage > 0 && (
                <div style={styles.warningBox}>
                  <strong>‚ö†Ô∏è {tripsWithoutMileage} trip{tripsWithoutMileage !== 1 ? 's' : ''} missing distance data.</strong>{' '}
                  Add distance to properties in{' '}
                  <button onClick={() => setView('properties')} style={{ background: 'none', border: 'none', color: '#856404', textDecoration: 'underline', cursor: 'pointer', fontSize: 'inherit', fontFamily: 'inherit', padding: 0 }}>
                    Properties & Roost Sites
                  </button>.
                </div>
              )}

              {/* Summary by Property */}
              {Object.keys(byProperty).length > 0 && (
                <>
                  <h3 style={{ fontSize: '20px', color: '#2c5530', marginTop: '32px', marginBottom: '16px' }}>Summary by Property</h3>
                  <table style={styles.table}>
                    <thead>
                      <tr>
                        <th style={styles.th}>Property</th>
                        <th style={{ ...styles.th, textAlign: 'center' }}>One-way (km)</th>
                        <th style={{ ...styles.th, textAlign: 'center' }}>Trips</th>
                        <th style={{ ...styles.th, textAlign: 'center' }}>Total km</th>
                      </tr>
                    </thead>
                    <tbody>
                      {Object.entries(byProperty).map(([propName, data]) => (
                        <tr key={propName}>
                          <td style={styles.td}>{propName}</td>
                          <td style={{ ...styles.td, textAlign: 'center' }}>{data.distanceKm || '‚Äî'}</td>
                          <td style={{ ...styles.td, textAlign: 'center' }}>{data.trips}</td>
                          <td style={{ ...styles.td, textAlign: 'center', fontWeight: 'bold' }}>{data.totalKm.toFixed(1)}</td>
                        </tr>
                      ))}
                      <tr style={{ backgroundColor: '#e8f5e9' }}>
                        <td style={{ ...styles.td, fontWeight: 'bold' }}>Total</td>
                        <td style={styles.td}></td>
                        <td style={{ ...styles.td, textAlign: 'center', fontWeight: 'bold' }}>{yearCounts.length}</td>
                        <td style={{ ...styles.td, textAlign: 'center', fontWeight: 'bold', fontSize: '18px' }}>{totalKm.toFixed(1)}</td>
                      </tr>
                    </tbody>
                  </table>
                </>
              )}

              {/* Detailed Trip Log */}
              {yearCounts.length > 0 && (
                <>
                  <h3 style={{ fontSize: '20px', color: '#2c5530', marginTop: '32px', marginBottom: '16px' }}>Trip Log</h3>
                  <div style={styles.infoBox}>
                    This log can be used for volunteer expense reimbursement or charitable donation receipts. 
                    All trips are from 83 Blue Heron Road, Thetis Island to the property and back.
                  </div>
                  <div style={{ overflowX: 'auto' }}>
                    <table style={{ ...styles.table, fontSize: '16px' }}>
                      <thead>
                        <tr>
                          <th style={styles.th}>Date</th>
                          <th style={styles.th}>Property</th>
                          <th style={styles.th}>Roost Site</th>
                          <th style={styles.th}>Purpose</th>
                          <th style={{ ...styles.th, textAlign: 'center' }}>Round Trip (km)</th>
                        </tr>
                      </thead>
                      <tbody>
                        {yearCounts.map(count => (
                          <tr key={count.id}>
                            <td style={styles.td}>{formatDate(count.date)}</td>
                            <td style={styles.td}>{count.property?.name || 'Unknown'}</td>
                            <td style={styles.td}>{count.site?.name || 'Unknown'}</td>
                            <td style={styles.td}>BC Annual Bat Count</td>
                            <td style={{ ...styles.td, textAlign: 'center', fontWeight: count.roundTripKm > 0 ? 'bold' : 'normal', color: count.roundTripKm === 0 ? '#999' : 'inherit' }}>
                              {count.roundTripKm > 0 ? count.roundTripKm.toFixed(1) : '‚Äî'}
                            </td>
                          </tr>
                        ))}
                        <tr style={{ backgroundColor: '#e8f5e9' }}>
                          <td colSpan="4" style={{ ...styles.td, fontWeight: 'bold', textAlign: 'right' }}>Total Mileage:</td>
                          <td style={{ ...styles.td, textAlign: 'center', fontWeight: 'bold', fontSize: '18px' }}>{totalKm.toFixed(1)} km</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </>
              )}

              {yearCounts.length === 0 && (
                <div style={styles.emptyState}>
                  <p>No counting sessions recorded for {selectedYear}.</p>
                </div>
              )}
            </div>

            <button onClick={() => setView('home')} style={{ ...styles.button, ...styles.buttonSecondary }}>‚Üê Back to Home</button>
          </div>
        );
      };

      // ============ MAIN RENDER ============
      return (
        <div style={styles.container}>
          {message && (
            <div style={{ ...styles.message, ...(message.type === 'error' ? styles.messageError : styles.messageSuccess) }}>
              {message.text}
            </div>
          )}

          <header style={styles.header}>
            <div style={styles.headerTop}>
              <div style={styles.headerBrand}>
                <span style={{ fontSize: '40px' }}>ü¶á</span>
                <div>
                  <h1 style={styles.title}>Thetis Island Bat Count</h1>
                  <p style={styles.subtitle}>In partnership with the BC Community Bat Program & Thetis Island Nature Conservancy</p>
                </div>
              </div>
              <a href="https://www.thetisislandnatureconservancy.org" target="_blank" rel="noopener noreferrer" title="Thetis Island Nature Conservancy">
                <img src="https://static.wixstatic.com/media/a5ed41_b0523212bda343688442821f3d57635e~mv2.png/v1/crop/x_0,y_37,w_1000,h_926/fill/w_135,h_125,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/ThINC%20logo_1000x1000px.png" alt="ThINC Logo" style={styles.thincLogo} />
              </a>
            </div>
            {view !== 'home' && (
              <button onClick={() => setView('home')} style={{ ...styles.navButton, ...styles.navButtonSecondary }}>‚Üê Back to Home</button>
            )}
          </header>

          {view === 'home' && <HomeView />}
          {view === 'settings' && <SettingsView />}
          {view === 'appSettings' && <AppSettingsView />}
          {view === 'impactReport' && <ImpactReportView />}
          {view === 'season' && <SeasonView />}
          {view === 'mileage' && <MileageReportView />}
          {view === 'properties' && <PropertiesView />}
          {view === 'editProperty' && <EditPropertyView />}
          {view === 'editSite' && <EditSiteView />}
          {view === 'newCount' && <NewCountForm />}
          {view === 'editCount' && <EditCountView />}
          {view === 'history' && <HistoryView />}

          <footer style={{ marginTop: '48px', padding: '32px 24px', textAlign: 'center', borderTop: `2px solid ${colors.sand}` }}>
            <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', gap: '24px', marginBottom: '20px', flexWrap: 'wrap' }}>
              <a href="https://www.thetisislandnatureconservancy.org" target="_blank" rel="noopener noreferrer" style={{ textDecoration: 'none' }}>
                <img src="https://static.wixstatic.com/media/a5ed41_b0523212bda343688442821f3d57635e~mv2.png/v1/crop/x_0,y_37,w_1000,h_926/fill/w_80,h_74,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/ThINC%20logo_1000x1000px.png" alt="ThINC Logo" style={{ height: '60px' }} />
                <p style={{ margin: '8px 0 0 0', fontSize: '12px', color: colors.sage }}>thetisislandnatureconservancy.org</p>
              </a>
              <div style={{ width: '1px', height: '50px', backgroundColor: colors.sand }}></div>
              <a href="https://bcbats.ca" target="_blank" rel="noopener noreferrer" style={{ textDecoration: 'none', textAlign: 'left' }}>
                <p style={{ margin: 0, fontWeight: '600', color: colors.forest }}>BC Community Bat Program</p>
                <p style={{ margin: '4px 0 0 0', fontSize: '12px', color: colors.sage }}>bcbats.ca</p>
              </a>
            </div>
          </footer>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<BatCountApp />);
  </script>
</body>
</html>

